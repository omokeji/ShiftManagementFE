<!-- meta tags and other links -->
<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MaxiCare - My Shifts</title>
  <link rel="icon" type="image/png" href="assets/images/favicon.png" sizes="16x16">
  <!-- remix icon font css  -->
  <link rel="stylesheet" href="assets/css/remixicon.css">
  <!-- BootStrap css -->
  <link rel="stylesheet" href="assets/css/lib/bootstrap.min.css">
  <!-- Apex Chart css -->
  <link rel="stylesheet" href="assets/css/lib/apexcharts.css">
  <!-- Data Table css -->
  <link rel="stylesheet" href="assets/css/lib/dataTables.min.css">
  <!-- Text Editor css -->
  <link rel="stylesheet" href="assets/css/lib/editor-katex.min.css">
  <link rel="stylesheet" href="assets/css/lib/editor.atom-one-dark.min.css">
  <link rel="stylesheet" href="assets/css/lib/editor.quill.snow.css">
  <!-- Date picker css -->
  <link rel="stylesheet" href="assets/css/lib/flatpickr.min.css">
  <!-- Calendar css -->
  <link rel="stylesheet" href="assets/css/lib/full-calendar.css">
  <!-- Vector Map css -->
  <link rel="stylesheet" href="assets/css/lib/jquery-jvectormap-2.0.5.css">
  <!-- Popup css -->
  <link rel="stylesheet" href="assets/css/lib/magnific-popup.css">
  <!-- Slick Slider css -->
  <link rel="stylesheet" href="assets/css/lib/slick.css">
  <!-- prism css -->
  <link rel="stylesheet" href="assets/css/lib/prism.css">
  <!-- file upload css -->
  <link rel="stylesheet" href="assets/css/lib/file-upload.css">

  <link rel="stylesheet" href="assets/css/lib/audioplayer.css">
  <!-- main css -->
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- Shift Management css -->
  <link rel="stylesheet" href="assets/css/shift-management.css">
  
  <!-- Custom styles for shift status colors -->
  <style>
    .bg-ready-to-start-50 {
      background-color: rgba(255, 159, 41, 0.1) !important;
    }
    .text-ready-to-start-600 {
      color: #FF9F29 !important;
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <button type="button" class="sidebar-close-btn">
      <iconify-icon icon="radix-icons:cross-2"></iconify-icon>
    </button>
    <div>
      <a href="employee-dashboard.html" class="sidebar-logo">
        <img src="assets/images/logo.png" alt="site logo" class="light-logo">
        <img src="assets/images/logo-light.png" alt="site logo" class="dark-logo">
        <img src="assets/images/logo-icon.png" alt="site logo" class="logo-icon">
      </a>
    </div>
    <div class="sidebar-menu-area">
      <ul class="sidebar-menu" id="sidebar-menu">
        <li>
          <a href="employee-dashboard.html">
            <iconify-icon icon="solar:home-smile-angle-outline" class="menu-icon"></iconify-icon>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="javascript:void(0)" class="disabled-link" style="opacity: 0.5; cursor: not-allowed;">
            <iconify-icon icon="solar:calendar-outline" class="menu-icon"></iconify-icon>
            <span>Calendar (Disabled)</span>
          </a>
        </li>
        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <iconify-icon icon="flowbite:users-group-outline" class="menu-icon"></iconify-icon>
            <span>Users</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="users-list.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Users
                List</a>
            </li>
            <li>
              <a href="add-user.html"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> Add User</a>
            </li>
            <li>
              <a href="view-profile.html"><i class="ri-circle-fill circle-icon text-danger-main w-auto"></i> View
                Profile</a>
            </li>
          </ul>
        </li>

        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <i class="ri-user-settings-line text-xl me-14 d-flex w-auto"></i>
            <span>Role & Access</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="role-access.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Role &
                Access</a>
            </li>
            <li>
              <a href="assign-role.html"><i class="ri-circle-fill circle-icon text-warning-main w-auto"></i> Assign
                Role</a>
            </li>
          </ul>
        </li>

        <li class="employee-only">
          <a href="my-shifts.html">
            <iconify-icon icon="solar:clock-circle-outline" class="menu-icon"></iconify-icon>
            <span>My Shifts</span>
          </a>
        </li>

        <li class="employee-only">
          <a href="available-shifts.html">
            <iconify-icon icon="solar:calendar-add-outline" class="menu-icon"></iconify-icon>
            <span>Available Shifts</span>
          </a>
        </li>

        <li class="employee-only">
          <a href="employee-payouts.html">
            <iconify-icon icon="solar:dollar-minimalistic-outline" class="menu-icon"></iconify-icon>
            <span>My Payouts</span>
          </a>
        </li>

        <li class="employee-only">
          <a href="view-profile.html">
            <iconify-icon icon="solar:user-linear" class="menu-icon"></iconify-icon>
            <span>My Profile</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="dashboard-main">
    <div class="navbar-header">
      <div class="row align-items-center justify-content-between">
        <div class="col-auto">
          <div class="d-flex flex-wrap align-items-center gap-4">
            <button type="button" class="sidebar-toggle">
              <iconify-icon icon="heroicons:bars-3-solid" class="icon text-2xl non-active"></iconify-icon>
              <iconify-icon icon="iconoir:arrow-right" class="icon text-2xl active"></iconify-icon>
            </button>
            <button type="button" class="sidebar-mobile-toggle">
              <iconify-icon icon="heroicons:bars-3-solid" class="icon"></iconify-icon>
            </button>
            <form class="navbar-search">
              <input type="text" name="search" placeholder="Search">
              <iconify-icon icon="ion:search-outline" class="icon"></iconify-icon>
            </form>
          </div>
        </div>
        <div class="col-auto">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <button type="button" data-theme-toggle
              class="w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"></button>

            <div class="dropdown">
              <button
                class="has-indicator w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"
                type="button" data-bs-toggle="dropdown">
                <iconify-icon icon="iconoir:bell" class="text-primary-light text-xl"></iconify-icon>
              </button>
              <div class="dropdown-menu to-top dropdown-menu-lg p-0">
                <div
                  class="m-16 py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
                  <div>
                    <h6 class="text-lg text-primary-light fw-semibold mb-0">Notifications</h6>
                  </div>
                  <span
                    class="text-primary-600 fw-semibold text-lg w-40-px h-40-px rounded-circle bg-base d-flex justify-content-center align-items-center" id="notificationCount">0</span>
                </div>
                <div class="text-center py-12 px-16">
                  <p class="text-secondary-light mb-0">No new notifications</p>
                </div>
              </div>
            </div><!-- Notification dropdown end -->

            <div class="dropdown">
              <button class="d-flex justify-content-center align-items-center rounded-circle" type="button"
                data-bs-toggle="dropdown">
                <img src="assets/images/user.png" alt="image" class="w-40-px h-40-px object-fit-cover rounded-circle">
              </button>
              <div class="dropdown-menu to-top dropdown-menu-sm">
                <div
                  class="py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
                  <div>
                    <h6 class="text-lg text-primary-light fw-semibold mb-2 user-name">Loading...</h6>
                    <span class="text-secondary-light fw-medium text-sm user-role">Loading...</span>
                  </div>
                  <button type="button" class="hover-text-danger">
                    <iconify-icon icon="radix-icons:cross-1" class="icon text-xl"></iconify-icon>
                  </button>
                </div>
                <ul class="to-top-list">
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3"
                      href="view-profile.html">
                      <iconify-icon icon="solar:user-linear" class="icon text-xl"></iconify-icon> My Profile</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3"
                      href="company.html">
                      <iconify-icon icon="icon-park-outline:setting-two" class="icon text-xl"></iconify-icon>
                      Setting</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-danger d-flex align-items-center gap-3"
                      href="javascript:void(0)" id="logoutBtn">
                      <iconify-icon icon="lucide:power" class="icon text-xl"></iconify-icon> Log Out</a>
                  </li>
                </ul>
              </div>
            </div><!-- Profile dropdown end -->
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-main-body">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <h6 class="fw-semibold mb-0">My Shifts</h6>
        <ul class="d-flex align-items-center gap-2">
          <li class="fw-medium">
            <a href="index.html" class="d-flex align-items-center gap-1 hover-text-primary">
              <iconify-icon icon="solar:home-smile-angle-outline" class="icon text-lg"></iconify-icon>
              Dashboard
            </a>
          </li>
          <li>-</li>
          <li class="fw-medium">My Shifts</li>
        </ul>
      </div>

      <!-- Summary Cards -->
      <div class="row gy-4 mb-24">
        <div class="col-md-3">
          <div class="card h-100 border">
            <div class="card-body p-20 text-center">
              <div class="w-50-px h-50-px bg-primary-50 rounded-circle d-flex justify-content-center align-items-center mx-auto mb-12">
                <iconify-icon icon="solar:clock-circle-outline" class="text-primary-600 text-2xl"></iconify-icon>
              </div>
              <h6 class="fw-semibold mb-1" id="totalShifts">0</h6>
              <p class="text-secondary-light text-sm mb-0">Total Shifts</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100 border">
            <div class="card-body p-20 text-center">
              <div class="w-50-px h-50-px bg-success-50 rounded-circle d-flex justify-content-center align-items-center mx-auto mb-12">
                <iconify-icon icon="solar:check-circle-outline" class="text-success-600 text-2xl"></iconify-icon>
              </div>
              <h6 class="fw-semibold mb-1" id="completedShifts">0</h6>
              <p class="text-secondary-light text-sm mb-0">Completed</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100 border">
            <div class="card-body p-20 text-center">
              <div class="w-50-px h-50-px bg-warning-50 rounded-circle d-flex justify-content-center align-items-center mx-auto mb-12">
                <iconify-icon icon="solar:clock-square-outline" class="text-warning-600 text-2xl"></iconify-icon>
              </div>
              <h6 class="fw-semibold mb-1" id="scheduledShifts">0</h6>
              <p class="text-secondary-light text-sm mb-0">Scheduled</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100 border">
            <div class="card-body p-20 text-center">
              <div class="w-50-px h-50-px bg-info-50 rounded-circle d-flex justify-content-center align-items-center mx-auto mb-12">
                <iconify-icon icon="solar:clock-circle-bold" class="text-info-600 text-2xl"></iconify-icon>
              </div>
              <h6 class="fw-semibold mb-1" id="inProgressShifts">0</h6>
              <p class="text-secondary-light text-sm mb-0">In Progress</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row gy-4">
        <div class="col-12">
          <div class="card h-100 p-0 radius-12">
            <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center flex-wrap gap-3 justify-content-between">
              <div class="d-flex align-items-center flex-wrap gap-3">
                <span class="text-md fw-medium text-secondary-light mb-0">Filter by:</span>
                <select class="form-select form-select-sm w-auto ps-12 py-6 radius-12 h-40-px" id="statusFilter">
                  <option value="">All Status</option>
                  <option value="scheduled">Scheduled</option>
                  <option value="in-progress">In Progress</option>
                  <option value="completed">Completed</option>
                </select>
                <select class="form-select form-select-sm w-auto ps-12 py-6 radius-12 h-40-px" id="dateFilter">
                  <option value="">All Dates</option>
                  <option value="today">Today</option>
                  <option value="tomorrow">Tomorrow</option>
                  <option value="this-week">This Week</option>
                  <option value="next-week">Next Week</option>
                </select>
              </div>
              <button class="btn btn-primary text-sm btn-sm px-12 py-12 radius-8 d-flex align-items-center gap-2" onclick="refreshShifts()">
                <iconify-icon icon="solar:refresh-outline" class="icon text-xl line-height-1"></iconify-icon>
                Refresh
              </button>
            </div>
            <div class="card-body p-24">
              <div id="shiftsContainer">
                <div class="text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-3 text-secondary-light">Loading your shifts...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Time Summary and Recent Entries Section -->
      <div class="row gy-4 mt-4">
        <div class="col-md-6">
          <div class="card h-100 p-0 radius-12">
            <div class="card-header border-bottom bg-base py-16 px-24">
              <h6 class="fw-semibold mb-0">Today's Time Summary</h6>
            </div>
            <div class="card-body p-24">
              <div id="timeSummaryContainer">
                <div class="d-flex flex-column align-items-center">
                  <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="text-secondary-light mb-0">Loading time summary...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card h-100 p-0 radius-12">
            <div class="card-header border-bottom bg-base py-16 px-24">
              <h6 class="fw-semibold mb-0">Recent Time Entries</h6>
            </div>
            <div class="card-body p-24">
              <div id="recentEntriesContainer">
                <div class="d-flex flex-column align-items-center">
                  <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="text-secondary-light mb-0">Loading recent entries...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </div>

  <!-- Clock In Confirmation Modal -->
  <div class="modal fade" id="clockInModal" tabindex="-1" aria-labelledby="clockInModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-semibold" id="clockInModalLabel">Clock In</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-0">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="w-50-px h-50-px bg-success-50 rounded-circle d-flex justify-content-center align-items-center">
              <iconify-icon icon="solar:login-3-outline" class="text-success-600 text-xl"></iconify-icon>
            </div>
            <div>
              <h6 class="mb-1 fw-semibold" id="clockInShiftTitle">Shift Title</h6>
              <p class="text-secondary-light text-sm mb-0" id="clockInShiftDetails">Shift details</p>
            </div>
          </div>
          <p class="text-secondary-light mb-3">Are you ready to clock in for this shift?</p>
          <div class="alert alert-info d-flex align-items-center" role="alert">
            <iconify-icon icon="solar:location-outline" class="text-info-600 me-2"></iconify-icon>
            <small>Your location will be verified to ensure you're within the job site radius.</small>
          </div>
          <div id="locationStatus" class="mt-3">
            <div class="d-flex align-items-center gap-2">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <small class="text-secondary-light">Getting your location...</small>
            </div>
          </div>
          <div id="geofenceInfo" class="mt-2" style="display: none;">
            <div class="alert alert-success d-flex align-items-center" role="alert">
              <iconify-icon icon="solar:check-circle-outline" class="text-success-600 me-2"></iconify-icon>
              <div>
                <small class="text-success-600 fw-semibold">Location verified</small>
                <div id="distanceInfo" class="text-success-600 text-xs"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="confirmClockInBtn" disabled>
            <iconify-icon icon="solar:login-3-outline" class="icon text-sm me-1"></iconify-icon>
            Clock In
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Clock Out Confirmation Modal -->
  <div class="modal fade" id="clockOutModal" tabindex="-1" aria-labelledby="clockOutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-semibold" id="clockOutModalLabel">Clock Out</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-0">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="w-50-px h-50-px bg-warning-50 rounded-circle d-flex justify-content-center align-items-center">
              <iconify-icon icon="solar:logout-3-outline" class="text-warning-600 text-xl"></iconify-icon>
            </div>
            <div>
              <h6 class="mb-1 fw-semibold" id="clockOutShiftTitle">Shift Title</h6>
              <p class="text-secondary-light text-sm mb-0" id="clockOutShiftDetails">Shift details</p>
            </div>
          </div>
          <p class="text-secondary-light mb-3">Are you ready to clock out?</p>
          <div class="mb-3">
            <label for="clockOutNote" class="form-label">Add a note (optional)</label>
            <textarea class="form-control" id="clockOutNote" rows="3" placeholder="Any notes about your shift..."></textarea>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="confirmClockOutBtn">
            <iconify-icon icon="solar:logout-3-outline" class="icon text-sm me-1"></iconify-icon>
            Clock Out
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="d-footer">
      <div class="row align-items-center justify-content-between">
        <div class="col-auto">
          <p class="mb-0">© 2024 MaxiCare. All Rights Reserved.</p>
        </div>
        <div class="col-auto">
          <p class="mb-0">Made with <span class="text-primary-600">❤️</span> for MaxiCare</p>
        </div>
      </div>
    </footer>
  </main>

  <!-- jQuery library js -->
  <script src="assets/js/lib/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap js -->
  <script src="assets/js/lib/bootstrap.bundle.min.js"></script>
  <!-- Apex Chart js -->
  <script src="assets/js/lib/apexcharts.min.js"></script>
  <!-- Data Table js -->
  <script src="assets/js/lib/dataTables.min.js"></script>
  <!-- Iconify Font js -->
  <script src="assets/js/lib/iconify-icon.min.js"></script>
  <!-- jQuery UI js -->
  <script src="assets/js/lib/jquery-ui.min.js"></script>
  <!-- Vector Map js -->
  <script src="assets/js/lib/jquery-jvectormap-2.0.5.min.js"></script>
  <script src="assets/js/lib/jquery-jvectormap-world-mill-en.js"></script>
  <!-- Popup js -->
  <script src="assets/js/lib/magnifc-popup.min.js"></script>
  <!-- Slick Slider js -->
  <script src="assets/js/lib/slick.min.js"></script>
  <!-- prism js -->
  <script src="assets/js/lib/prism.js"></script>
  <!-- file upload js -->
  <script src="assets/js/lib/file-upload.js"></script>
  <!-- audioplayer -->
  <script src="assets/js/lib/audioplayer.js"></script>

  <!-- API and Auth services -->

  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/router.js"></script>
  <script src="assets/js/profile-picture.js"></script>
  <!-- main js -->
  <script src="assets/js/app.js"></script>

  <script>
    // My shifts management
    let userShifts = [];
    let filteredShifts = [];
    let userClockInRecords = [];
    let progressUpdateInterval = null;

    // Toast notification system
    function showToast(message, type = 'success') {
      const toastContainer = document.getElementById('toastContainer') || createToastContainer();
      
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body d-flex align-items-center gap-2">
            <iconify-icon icon="${type === 'success' ? 'solar:check-circle-outline' : 'solar:close-circle-outline'}" class="icon text-lg"></iconify-icon>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
      });
      
      bsToast.show();
      
      // Remove toast element after it's hidden
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      container.style.zIndex = '9999';
      document.body.appendChild(container);
      return container;
    }

    document.addEventListener('DOMContentLoaded', async function() {
      // Check authentication
      if (!authService.requireAuth()) {
        return;
      }

      // Check if user is employee
      if (!authService.isEmployee()) {
        console.log('Non-employee trying to access my shifts, redirecting to admin dashboard');
        window.location.href = 'index.html';
        return;
      }

      // Add logout functionality
      document.getElementById('logoutBtn').addEventListener('click', async function() {
          await authService.logout();
          window.location.href = 'sign-in.html';
      });

      // Add filter event listeners
      document.getElementById('statusFilter').addEventListener('change', filterShifts);
      document.getElementById('dateFilter').addEventListener('change', filterShifts);

      // Add modal event listeners
      document.getElementById('confirmClockInBtn').addEventListener('click', async function() {
        if (currentClockInShiftId) {
          await clockIn(currentClockInShiftId);
          const modal = bootstrap.Modal.getInstance(document.getElementById('clockInModal'));
          modal.hide();
          currentClockInShiftId = null;
        }
      });

      document.getElementById('confirmClockOutBtn').addEventListener('click', async function() {
        if (currentClockOutShiftId) {
          await clockOut(currentClockOutShiftId);
          const modal = bootstrap.Modal.getInstance(document.getElementById('clockOutModal'));
          modal.hide();
          currentClockOutShiftId = null;
        }
      });

      // Load user shifts and additional data
      await loadUserShifts();
      await loadTimeSummary();
      await loadRecentEntries();
      
      // Set up data reloading when authentication is restored
      setupAuthDataReloading();
    });

    async function loadUserShifts() {
      try {
        console.log('Loading user shifts...');
        const response = await maxicareAPI.getMyShifts();
        console.log('User shifts response:', response);
        if (response.status) {
          userShifts = response.data;
          filteredShifts = [...userShifts];
          
          // Debug shifts
          console.log('=== FRONTEND SHIFTS DEBUG ===');
          userShifts.forEach((shift, index) => {
            console.log(`Frontend Shift ${index + 1}:`, {
              id: shift.id,
              title: shift.title,
              status: shift.status
            });
          });
          // Store shifts for real-time updates
          currentShifts = response.data;
          console.log('Loaded shifts:', userShifts);
          
          // Load clock-in records and update summary
          await loadUserClockInRecords();
          await updateSummaryCards();
          renderShifts();
        } else {
          console.log('Failed to load shifts:', response.message);
          currentShifts = [];
          showNoShiftsMessage('Failed to load shifts: ' + response.message);
        }
      } catch (error) {
        console.error('Error loading user shifts:', error);
        currentShifts = [];
        showNoShiftsMessage('Failed to load shifts. Please try again.');
      }
    }

    // Cleanup function to clear intervals
    function cleanup() {
      if (progressUpdateInterval) {
        clearInterval(progressUpdateInterval);
        progressUpdateInterval = null;
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', cleanup);

    async function loadUserClockInRecords() {
      try {
        const currentUser = authService.getCurrentUser();
        if (!currentUser) return;
        
        const response = await maxicareAPI.getUserClockInRecords(currentUser.id, 1, 100);
        if (response.status) {
          userClockInRecords = response.data.records || [];
          console.log('Loaded clock-in records:', userClockInRecords);
        } else {
          console.error('Failed to load clock-in records:', response.message);
          userClockInRecords = [];
        }
      } catch (error) {
        console.error('Error loading clock-in records:', error);
        userClockInRecords = [];
      }
    }

    async function updateSummaryCards() {
      const total = userShifts.length;
      const currentUserId = authService.getCurrentUser()?.id;
      
      let completed = 0;
      let scheduled = 0;
      let inProgress = 0;
      
      userShifts.forEach(shift => {
        // Find clock-in records for this shift
        const shiftClockRecords = userClockInRecords.filter(record => record.shiftId === shift.id);
        
        // Check if user has clocked in but not clocked out (in progress)
        const hasActiveClockIn = shiftClockRecords.some(record => 
          record.clockInTime && !record.clockOutTime
        );
        
        // Check if user has completed the shift (clocked out)
        const hasCompletedShift = shiftClockRecords.some(record => 
          record.clockInTime && record.clockOutTime
        );
        
        if (hasCompletedShift) {
          completed++;
        } else if (hasActiveClockIn) {
          inProgress++;
        } else {
          scheduled++;
        }
      });

      document.getElementById('totalShifts').textContent = total;
      document.getElementById('completedShifts').textContent = completed;
      document.getElementById('scheduledShifts').textContent = scheduled;
      document.getElementById('inProgressShifts').textContent = inProgress;
    }

    function filterShifts() {
      const statusFilter = document.getElementById('statusFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;

      filteredShifts = userShifts.filter(shift => {
        let matchesStatus = true;
        let matchesDate = true;

        // Status filtering
        if (statusFilter) {
          matchesStatus = shift.status === statusFilter;
        }

        // Date filtering
        if (dateFilter) {
          const shiftDate = new Date(shift.date);
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          switch (dateFilter) {
            case 'today':
              matchesDate = shiftDate.toDateString() === today.toDateString();
              break;
            case 'tomorrow':
              const tomorrow = new Date(today);
              tomorrow.setDate(tomorrow.getDate() + 1);
              matchesDate = shiftDate.toDateString() === tomorrow.toDateString();
              break;
            case 'this-week':
              const weekStart = new Date(today);
              weekStart.setDate(today.getDate() - today.getDay());
              const weekEnd = new Date(weekStart);
              weekEnd.setDate(weekStart.getDate() + 6);
              matchesDate = shiftDate >= weekStart && shiftDate <= weekEnd;
              break;
            case 'next-week':
              const nextWeekStart = new Date(today);
              nextWeekStart.setDate(today.getDate() + (7 - today.getDay()));
              const nextWeekEnd = new Date(nextWeekStart);
              nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
              matchesDate = shiftDate >= nextWeekStart && shiftDate <= nextWeekEnd;
              break;
          }
        }

        return matchesStatus && matchesDate;
      });

      renderShifts();
    }

    function renderShifts() {
      const container = document.getElementById('shiftsContainer');
      
      if (filteredShifts.length === 0) {
        showNoShiftsMessage('No shifts found for the selected criteria.');
        return;
      }

      container.innerHTML = '';

      filteredShifts.forEach(shift => {
        const shiftCard = createShiftCard(shift);
        container.appendChild(shiftCard);
      });
      
      // Start real-time updates for progress bars
      startProgressUpdates();
    }

    function startProgressUpdates() {
      // Clear any existing interval
      if (progressUpdateInterval) {
        clearInterval(progressUpdateInterval);
      }
      
      // Update progress bars every 30 seconds for active shifts
      progressUpdateInterval = setInterval(() => {
        updateProgressBars();
      }, 30000);
    }

    function updateProgressBars() {
      const now = new Date();
      
      filteredShifts.forEach(shift => {
        const shiftCard = document.querySelector(`[data-shift-id="${shift.id}"]`);
        if (!shiftCard) return;
        
        const statusInfo = getStatusInfo(shift, now);
        const progressBar = shiftCard.querySelector('.progress-bar');
        const timeRemaining = shiftCard.querySelector('.time-remaining');
        const statusMessage = shiftCard.querySelector('.status-message');
        
        if (progressBar) {
          progressBar.style.width = `${statusInfo.progress}%`;
        }
        
        if (timeRemaining && statusInfo.timeRemaining) {
          timeRemaining.innerHTML = `
            <iconify-icon icon="solar:clock-circle-outline" class="icon text-sm"></iconify-icon>
            ${statusInfo.timeRemaining}
          `;
        }
        
        if (statusMessage) {
          statusMessage.innerHTML = `
            <span class="text-sm ${getStatusMessageClass(shift.status)}">
              <iconify-icon icon="${getStatusMessageIcon(shift.status)}" class="icon text-sm me-1"></iconify-icon>
              ${statusInfo.message}
            </span>
          `;
        }
      });
    }

    function createShiftCard(shift) {
      const div = document.createElement('div');
      div.className = 'card mb-3 border shift-card shift-card-hover';
      
      // Handle different date/time formats
      let startTime, endTime;
      
      if (shift.startTime && shift.endTime) {
        // If startTime/endTime are already full datetime strings
        if (shift.startTime.includes('T') || shift.startTime.includes(' ')) {
          startTime = new Date(shift.startTime);
          endTime = new Date(shift.endTime);
        } else {
          // If startTime/endTime are just time (HH:MM:SS), combine with date
          startTime = new Date(`${shift.date}T${shift.startTime}`);
          endTime = new Date(`${shift.date}T${shift.endTime}`);
        }
      } else {
        // Fallback to using date field
        startTime = new Date(shift.date);
        endTime = new Date(shift.date);
      }
      
      const duration = Math.round((endTime - startTime) / (1000 * 60 * 60));
      const now = new Date();
      
      const statusColor = getStatusColor(shift);
      const statusIcon = getStatusIcon(shift);
      const statusInfo = getStatusInfo(shift, now);
      
      div.innerHTML = `
        <div class="card-body p-20" data-shift-id="${shift.id || ''}" data-date="${shift.date}" data-start-time="${shift.startTime}" data-end-time="${shift.endTime}" data-status="${shift.status}">
          <!-- Status Header -->
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center gap-3">
              <div class="status-indicator ${getStatusClassName(shift)}"></div>
              <h6 class="mb-0 fw-semibold text-primary-light">${shift.title}</h6>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="status-badge ${getStatusClassName(shift)}">
                <iconify-icon icon="${statusIcon}" class="icon text-sm"></iconify-icon>
                ${getStatusDisplayText(shift)}
              </span>
              ${statusInfo.timeRemaining ? `
                <div class="time-remaining ${getStatusClassName(shift)}">
                  <iconify-icon icon="solar:clock-circle-outline" class="icon text-sm"></iconify-icon>
                  ${statusInfo.timeRemaining}
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- Status Progress Bar -->
          <div class="status-progress mb-3">
            <div class="progress-bar ${getStatusClassName(shift)}" style="width: ${statusInfo.progress}%"></div>
          </div>
          
          <!-- Shift Details -->
          <div class="row align-items-center">
            <div class="col-md-8">
              <div class="d-flex align-items-center gap-4 text-secondary-light text-sm mb-2">
                <span class="d-flex align-items-center gap-1">
                  <iconify-icon icon="solar:calendar-outline" class="icon text-sm"></iconify-icon>
                  ${formatDate(shift.date)}
                </span>
                <span class="d-flex align-items-center gap-1">
                  <iconify-icon icon="solar:clock-circle-outline" class="icon text-sm"></iconify-icon>
                  ${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}
                </span>
                <span class="d-flex align-items-center gap-1">
                  <iconify-icon icon="solar:clock-square-outline" class="icon text-sm"></iconify-icon>
                  ${duration}h
                </span>
              </div>
              ${shift.description ? `<p class="text-secondary-light text-sm mb-0">${shift.description}</p>` : ''}
              
              <!-- Status Message -->
              <div class="status-message mt-2">
                <span class="text-sm ${getStatusMessageClass(shift.status)}">
                  <iconify-icon icon="${getStatusMessageIcon(shift.status)}" class="icon text-sm me-1"></iconify-icon>
                  ${statusInfo.message}
                </span>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <div class="d-flex flex-column gap-2 align-items-end">
                ${getActionButton(shift)}
              </div>
            </div>
          </div>
        </div>
      `;
      
      return div;
    }

    function getStatusClassName(shift) {
      // Find clock-in records for this shift
      const shiftClockRecords = userClockInRecords.filter(record => record.shiftId === shift.id);
      
      // Check if user has clocked in but not clocked out (in progress)
      const hasActiveClockIn = shiftClockRecords.some(record => 
        record.clockInTime && !record.clockOutTime
      );
      
      // Check if user has completed the shift (clocked out)
      const hasCompletedShift = shiftClockRecords.some(record => 
        record.clockInTime && record.clockOutTime
      );
      
      if (hasCompletedShift) return 'success';
      if (hasActiveClockIn) return 'important';
      return 'info';
    }

    function getStatusColor(shift) {
      // Find clock-in records for this shift
      const shiftClockRecords = userClockInRecords.filter(record => record.shiftId === shift.id);
      
      // Check if user has clocked in but not clocked out (in progress)
      const hasActiveClockIn = shiftClockRecords.some(record => 
        record.clockInTime && !record.clockOutTime
      );
      
      // Check if user has completed the shift (clocked out)
      const hasCompletedShift = shiftClockRecords.some(record => 
        record.clockInTime && record.clockOutTime
      );
      
      if (hasCompletedShift) return 'bg-success-50 text-success-600';
      if (hasActiveClockIn) return 'bg-warning-50 text-warning-600';
      return 'bg-ready-to-start-50 text-ready-to-start-600'; // Custom color #FF9F29 for scheduled/ready to start
    }

    function getStatusIcon(shift) {
      // Find clock-in records for this shift
      const shiftClockRecords = userClockInRecords.filter(record => record.shiftId === shift.id);
      
      // Check if user has clocked in but not clocked out (in progress)
      const hasActiveClockIn = shiftClockRecords.some(record => 
        record.clockInTime && !record.clockOutTime
      );
      
      // Check if user has completed the shift (clocked out)
      const hasCompletedShift = shiftClockRecords.some(record => 
        record.clockInTime && record.clockOutTime
      );
      
      if (hasCompletedShift) return 'solar:check-circle-outline';
      if (hasActiveClockIn) return 'solar:clock-circle-bold';
      return 'solar:clock-square-outline';
    }

    function getStatusDisplayText(shift) {
      // Find clock-in records for this shift
      const shiftClockRecords = userClockInRecords.filter(record => record.shiftId === shift.id);
      
      // Check if user has clocked in but not clocked out (in progress)
      const hasActiveClockIn = shiftClockRecords.some(record => 
        record.clockInTime && !record.clockOutTime
      );
      
      // Check if user has completed the shift (clocked out)
      const hasCompletedShift = shiftClockRecords.some(record => 
        record.clockInTime && record.clockOutTime
      );
      
      if (hasCompletedShift) return 'Completed';
      if (hasActiveClockIn) return 'In Progress';
      return 'Scheduled';
    }

    function getStatusInfo(shift, now) {
      // Handle different date/time formats
      let startTime, endTime;
      
      if (shift.startTime && shift.endTime) {
        // If startTime/endTime are already full datetime strings
        if (shift.startTime.includes('T') || shift.startTime.includes(' ')) {
          startTime = new Date(shift.startTime);
          endTime = new Date(shift.endTime);
        } else {
          // If startTime/endTime are just time (HH:MM:SS), combine with date
          startTime = new Date(`${shift.date}T${shift.startTime}`);
          endTime = new Date(`${shift.date}T${shift.endTime}`);
        }
      } else {
        // Fallback to using date field
        startTime = new Date(shift.date);
        endTime = new Date(shift.date);
      }
      
      // Check if the dates are valid
      if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
        return {
          progress: 0,
          message: 'Invalid shift time',
          timeRemaining: null
        };
      }
      
      const totalDuration = endTime - startTime;
      const currentUserId = authService.getCurrentUser()?.id;
      
      // Check if user has clocked in using the new clock-in records
      const shiftClockRecords = userClockInRecords.filter(record => record.shiftId === shift.id);
      const hasActiveClockIn = shiftClockRecords.some(record => 
        record.clockInTime && !record.clockOutTime
      );
      
      // Check if user has completed the shift (clocked out)
      const hasCompletedShift = shiftClockRecords.some(record => 
        record.clockInTime && record.clockOutTime
      );
      
      if (hasCompletedShift) {
        return {
          progress: 100,
          message: 'Shift completed successfully',
          timeRemaining: null
        };
      } else if (hasActiveClockIn) {
        // User has clocked in but not clocked out
        const clockRecord = shiftClockRecords.find(record => 
          record.clockInTime && !record.clockOutTime
        );
        const actualStartTime = clockRecord?.clockInTime ? new Date(clockRecord.clockInTime) : startTime;
        
        // Calculate real-time progress based on actual clock-in time
        const elapsed = now - actualStartTime;
        const progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
        const remaining = endTime - now;
        const remainingHours = Math.floor(remaining / (1000 * 60 * 60));
        const remainingMinutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        
        // Calculate elapsed time for display
        const elapsedHours = Math.floor(elapsed / (1000 * 60 * 60));
        const elapsedMinutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
        
        return {
          progress: progress,
          message: `Working for ${elapsedHours}h ${elapsedMinutes}m - ${Math.round(progress)}% complete`,
          timeRemaining: remaining > 0 ? `${remainingHours}h ${remainingMinutes}m left` : 'Shift ended'
        };
      } else {
        // User hasn't clocked in yet
        const timeUntilStart = startTime - now;
        const hoursUntilStart = Math.floor(timeUntilStart / (1000 * 60 * 60));
        const minutesUntilStart = Math.floor((timeUntilStart % (1000 * 60 * 60)) / (1000 * 60));
        
        // For scheduled shifts, show progress as countdown to start
        const totalTimeUntilStart = startTime - new Date(shift.date); // Time from start of day to shift start
        const timeFromDayStart = now - new Date(shift.date);
        const countdownProgress = Math.max(0, Math.min(100, (timeFromDayStart / totalTimeUntilStart) * 100));
        
        return {
          progress: timeUntilStart > 0 ? countdownProgress : 0,
          message: timeUntilStart > 0 ? 'Shift not started yet' : 'Ready to start',
          timeRemaining: timeUntilStart > 0 ? `Starts in ${hoursUntilStart}h ${minutesUntilStart}m` : 'Ready to clock in'
        };
      }
    }

    function getStatusMessageClass(status) {
      switch (status) {
        case 'completed': return 'text-success-600';
        case 'in-progress': return 'text-warning-600';
        case 'scheduled': return 'text-info-600';
        default: return 'text-secondary-600';
      }
    }

    function getStatusMessageIcon(status) {
      switch (status) {
        case 'completed': return 'solar:check-circle-outline';
        case 'in-progress': return 'solar:clock-circle-bold';
        case 'scheduled': return 'solar:clock-square-outline';
        default: return 'solar:info-circle-outline';
      }
    }

    function getActionButton(shift) {
      const now = new Date();
      
      // Handle different date/time formats
      let shiftStart, shiftEnd;
      
      if (shift.startTime && shift.endTime) {
        // If startTime/endTime are already full datetime strings
        if (shift.startTime.includes('T') || shift.startTime.includes(' ')) {
          shiftStart = new Date(shift.startTime);
          shiftEnd = new Date(shift.endTime);
        } else {
          // If startTime/endTime are just time (HH:MM:SS), combine with date
          shiftStart = new Date(`${shift.date}T${shift.startTime}`);
          shiftEnd = new Date(`${shift.date}T${shift.endTime}`);
        }
      } else {
        // Fallback to using date field
        shiftStart = new Date(shift.date);
        shiftEnd = new Date(shift.date);
      }
      
      // Check if the dates are valid
      if (isNaN(shiftStart.getTime()) || isNaN(shiftEnd.getTime())) {
        return `<span class="text-warning-600 text-sm">Invalid shift time</span>`;
      }
      
      // Check if current time is within shift window (30 minutes before start to end time)
      const thirtyMinsBefore = new Date(shiftStart.getTime() - 30 * 60000);
      const isWithinShiftWindow = now >= thirtyMinsBefore && now <= shiftEnd;
      
      // Check if user has clocked in (has an active clock record)
      const shiftClockRecords = userClockInRecords.filter(record => record.shiftId === shift.id);
      const hasActiveClockIn = shiftClockRecords.some(record => 
        record.clockInTime && !record.clockOutTime
      );
      
      // Debug logging for Shift 1 and 3
      if (shift.id === 1 || shift.id === 3) {
        console.log(`Shift ${shift.id} Debug:`, {
          shiftId: shift.id,
          shiftStatus: shift.status,
          shiftClockRecords: shiftClockRecords,
          hasActiveClockIn: hasActiveClockIn,
          now: now.toISOString(),
          shiftStart: shiftStart.toISOString(),
          shiftEnd: shiftEnd.toISOString(),
          thirtyMinsBefore: thirtyMinsBefore.toISOString(),
          isWithinShiftWindow: isWithinShiftWindow
        });
      }
      
      // Determine the actual status based on clock records
      if (hasActiveClockIn) {
        // User has clocked in but not clocked out
        if (isWithinShiftWindow) {
          return `
            <div class="d-flex gap-2">
              <button class="btn btn-shift-action btn-clock-out btn-sm" onclick="showClockOutModal(${shift.id})">
                <iconify-icon icon="solar:logout-3-outline" class="icon text-sm me-1"></iconify-icon>
                Clock Out
              </button>
              <button class="btn btn-shift-action btn-request-change btn-sm" onclick="requestClockInChange(${shift.id})">
                <iconify-icon icon="solar:clock-square-outline" class="icon text-sm me-1"></iconify-icon>
                Request Change
              </button>
            </div>
          `;
        } else {
          return `
            <span class="text-warning-600 text-sm">Shift ended - Clock out required</span>
          `;
        }
      } else {
        // User hasn't clocked in yet
        if (isWithinShiftWindow) {
          return `
            <button class="btn btn-shift-action btn-clock-in btn-sm" onclick="showClockInModal(${shift.id})">
              <iconify-icon icon="solar:login-3-outline" class="icon text-sm me-1"></iconify-icon>
              Clock In
            </button>
          `;
        } else {
          return `
            <span class="text-secondary-600 text-sm">
              ${now < thirtyMinsBefore ? 'Too early to clock in' : 'Shift ended'}
            </span>
          `;
        }
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-GB', {
        weekday: 'short',
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }

    function formatTime(dateTimeString) {
      if (!dateTimeString) return 'N/A';
      const date = new Date(dateTimeString);
      return date.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    }

    let currentClockInShiftId = null;
    let currentClockOutShiftId = null;
    let currentUserLocation = null;

    // Calculate distance between two coordinates using Haversine formula
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3959; // Earth's radius in miles
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c; // Distance in miles
    }

    // Get user's current location
    function getCurrentLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocation is not supported by this browser.'));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const location = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
              accuracy: position.coords.accuracy
            };
            currentUserLocation = location;
            resolve(location);
          },
          (error) => {
            let errorMessage = 'Unable to get your location. ';
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage += 'Please allow location access to clock in.';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage += 'Location information is unavailable.';
                break;
              case error.TIMEOUT:
                errorMessage += 'Location request timed out.';
                break;
              default:
                errorMessage += 'An unknown error occurred.';
                break;
            }
            reject(new Error(errorMessage));
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000 // 5 minutes
          }
        );
      });
    }

    function showClockInModal(shiftId) {
      const shift = userShifts.find(s => s.id === shiftId);
      if (!shift) return;

      currentClockInShiftId = shiftId;
      
      // Populate modal with shift details
      document.getElementById('clockInShiftTitle').textContent = shift.title;
      document.getElementById('clockInShiftDetails').textContent = 
        `${formatDate(shift.date)} • ${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}`;
      
      // Reset location status
      document.getElementById('locationStatus').innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <small class="text-secondary-light">Getting your location...</small>
        </div>
      `;
      
      // Disable clock in button initially
      document.getElementById('confirmClockInBtn').disabled = true;
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('clockInModal'));
      modal.show();
      
      // Get location and validate geofence
      getCurrentLocation()
        .then((location) => {
          // Check if shift has job location information
          if (shift.job && shift.job.location && shift.job.location.lat && shift.job.location.lon) {
            const jobLat = shift.job.location.lat;
            const jobLon = shift.job.location.lon;
            const jobRadius = shift.job.location.radius || 5; // Default 5 miles if not specified
            
            // Calculate distance to job location
            const distance = calculateDistance(location.latitude, location.longitude, jobLat, jobLon);
            
            if (distance <= jobRadius) {
              // Within geofence
              document.getElementById('locationStatus').innerHTML = `
                <div class="d-flex align-items-center gap-2">
                  <iconify-icon icon="solar:check-circle-outline" class="text-success-600"></iconify-icon>
                  <small class="text-success-600">Location verified (accuracy: ${Math.round(location.accuracy * 0.000621371)} miles)</small>
                </div>
              `;
              
              // Show geofence info
              document.getElementById('geofenceInfo').style.display = 'block';
              document.getElementById('distanceInfo').innerHTML = `
                Distance to job site: ${distance.toFixed(2)} miles (within ${jobRadius} mile radius)
              `;
              
              document.getElementById('confirmClockInBtn').disabled = false;
            } else {
              // Outside geofence
              document.getElementById('locationStatus').innerHTML = `
                <div class="d-flex align-items-center gap-2">
                  <iconify-icon icon="solar:danger-triangle-outline" class="text-danger-600"></iconify-icon>
                  <small class="text-danger-600">Outside job site radius</small>
                </div>
              `;
              
              // Show geofence info with error
              document.getElementById('geofenceInfo').style.display = 'block';
              document.getElementById('geofenceInfo').innerHTML = `
                <div class="alert alert-danger d-flex align-items-center" role="alert">
                  <iconify-icon icon="solar:danger-triangle-outline" class="text-danger-600 me-2"></iconify-icon>
                  <div>
                    <small class="text-danger-600 fw-semibold">Location not verified</small>
                    <div class="text-danger-600 text-xs">
                      Distance to job site: ${distance.toFixed(2)} miles (required: within ${jobRadius} mile radius)
                    </div>
                  </div>
                </div>
              `;
              
              document.getElementById('confirmClockInBtn').disabled = true;
            }
          } else {
            // No job location info - allow clock in but warn
            document.getElementById('locationStatus').innerHTML = `
              <div class="d-flex align-items-center gap-2">
                <iconify-icon icon="solar:warning-outline" class="text-warning-600"></iconify-icon>
                <small class="text-warning-600">Location verified (no geofence configured)</small>
              </div>
            `;
            
            document.getElementById('geofenceInfo').style.display = 'block';
            document.getElementById('geofenceInfo').innerHTML = `
              <div class="alert alert-warning d-flex align-items-center" role="alert">
                <iconify-icon icon="solar:warning-outline" class="text-warning-600 me-2"></iconify-icon>
                <div>
                  <small class="text-warning-600 fw-semibold">No geofence configured</small>
                  <div class="text-warning-600 text-xs">
                    This job type doesn't have location restrictions configured.
                  </div>
                </div>
              </div>
            `;
            
            document.getElementById('confirmClockInBtn').disabled = false;
          }
        })
        .catch((error) => {
          document.getElementById('locationStatus').innerHTML = `
            <div class="d-flex align-items-center gap-2">
              <iconify-icon icon="solar:danger-triangle-outline" class="text-danger-600"></iconify-icon>
              <small class="text-danger-600">${error.message}</small>
            </div>
          `;
          document.getElementById('geofenceInfo').style.display = 'none';
          document.getElementById('confirmClockInBtn').disabled = true;
        });
    }

    function showClockOutModal(shiftId) {
      const shift = userShifts.find(s => s.id === shiftId);
      if (!shift) return;

      currentClockOutShiftId = shiftId;
      
      // Populate modal with shift details
      document.getElementById('clockOutShiftTitle').textContent = shift.title;
      document.getElementById('clockOutShiftDetails').textContent = 
        `${formatDate(shift.date)} • ${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}`;
      
      // Clear note field
      document.getElementById('clockOutNote').value = '';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('clockOutModal'));
      modal.show();
    }

    async function clockIn(shiftId) {
      if (!currentUserLocation) {
        showToast('Location is required to clock in. Please try again.', 'error');
        return;
      }

      try {
        const response = await maxicareAPI.clockIn(shiftId, currentUserLocation.latitude, currentUserLocation.longitude);
        if (response.status) {
          showToast('Clocked in successfully!', 'success');
          await loadUserShifts(); // Reload the shifts
        } else {
          showToast('Failed to clock in: ' + response.message, 'error');
        }
      } catch (error) {
        showToast('Failed to clock in: ' + error.message, 'error');
      }
    }

    async function clockOut(shiftId) {
      const note = document.getElementById('clockOutNote').value;
      
      try {
        const response = await maxicareAPI.clockOut(shiftId, note || '');
        if (response.status) {
          showToast('Clocked out successfully!', 'success');
          await loadUserShifts(); // Reload the shifts
        } else {
          showToast('Failed to clock out: ' + response.message, 'error');
        }
      } catch (error) {
        showToast('Failed to clock out: ' + error.message, 'error');
      }
    }

    async function requestClockInChange(shiftId) {
      const newTime = prompt('Enter new clock-in time (format: HH:MM, e.g., 08:30):');
      
      if (!newTime) return;
      
      // Validate time format
      const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
      if (!timeRegex.test(newTime)) {
        showToast('Please enter time in HH:MM format (e.g., 08:30)', 'error');
        return;
      }
      
      try {
        // Create a date object for today with the new time
        const today = new Date();
        const [hours, minutes] = newTime.split(':');
        const requestedClockIn = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parseInt(hours), parseInt(minutes));
        
        const response = await maxicareAPI.requestClockInChange(shiftId, requestedClockIn);
        if (response.status) {
          showToast('Clock-in change request submitted successfully!', 'success');
          await loadUserShifts(); // Reload the shifts
        } else {
          showToast('Failed to submit request: ' + response.message, 'error');
        }
      } catch (error) {
        showToast('Failed to submit request: ' + error.message, 'error');
      }
    }

    async function dropShift(shiftId) {
      if (!confirm('Are you sure you want to drop this shift?')) {
        return;
      }

      try {
        const response = await maxicareAPI.dropShift(shiftId);
        if (response.status) {
          showToast('Shift dropped successfully!', 'success');
          await loadUserShifts(); // Reload the shifts
        } else {
          showToast('Failed to drop shift: ' + response.message, 'error');
        }
      } catch (error) {
        showToast('Failed to drop shift: ' + error.message, 'error');
      }
    }

    async function loadTimeSummary() {
      try {
        const response = await maxicareAPI.getTodayTimeSummary();
        if (response.status) {
          renderTimeSummary(response.data);
        } else {
          document.getElementById('timeSummaryContainer').innerHTML = `
            <div class="text-center">
              <p class="text-secondary-light mb-0">No time data available</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading time summary:', error);
        document.getElementById('timeSummaryContainer').innerHTML = `
          <div class="text-center">
            <p class="text-danger mb-0">Error loading time summary</p>
          </div>
        `;
      }
    }

    async function loadRecentEntries() {
      try {
        const currentUser = authService.getCurrentUser();
        if (!currentUser) {
          throw new Error('User not found');
        }
        
        const response = await maxicareAPI.getUserClockInRecords(currentUser.id, 1, 10);
        if (response.status && response.data.records) {
          // Transform clockin records to match the expected format
          const transformedEntries = response.data.records.map(record => ({
            clockIn: record.clockInTime,
            clockOut: record.clockOutTime,
            title: record.shift?.title || 'Shift',
            duration: record.durationInMinutes || 0
          }));
          renderRecentEntries(transformedEntries);
        } else {
          document.getElementById('recentEntriesContainer').innerHTML = `
            <div class="text-center">
              <p class="text-secondary-light mb-0">No recent entries available</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading recent entries:', error);
        document.getElementById('recentEntriesContainer').innerHTML = `
          <div class="text-center">
            <p class="text-danger mb-0">Error loading recent entries</p>
          </div>
        `;
      }
    }

    function renderTimeSummary(summary) {
      const container = document.getElementById('timeSummaryContainer');
      
      if (!summary) {
        container.innerHTML = `
          <div class="text-center">
            <div class="w-50-px h-50-px bg-secondary-50 rounded-circle d-flex justify-content-center align-items-center mx-auto mb-12">
              <iconify-icon icon="solar:clock-circle-outline" class="text-secondary-600 text-2xl"></iconify-icon>
            </div>
            <p class="text-secondary-light mb-0">No time data available</p>
          </div>
        `;
        return;
      }

      const totalHours = Math.floor(summary.totalHoursWorked);
      const totalMinutes = Math.round((summary.totalHoursWorked - totalHours) * 60);
      
      container.innerHTML = `
        <div class="text-center mb-3">
          <div class="w-60-px h-60-px bg-primary-50 rounded-circle d-flex justify-content-center align-items-center mx-auto mb-12">
            <iconify-icon icon="solar:clock-circle-bold" class="text-primary-600 text-3xl"></iconify-icon>
          </div>
          <h4 class="fw-bold text-primary-600 mb-1">${totalHours}h ${totalMinutes}m</h4>
          <p class="text-secondary-light text-sm mb-0">Total Time Today</p>
        </div>
        <div class="border-top pt-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-sm text-secondary-light">Shifts:</span>
            <span class="text-sm fw-semibold">${summary.totalShifts}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-sm text-secondary-light">Completed:</span>
            <span class="text-sm fw-semibold">${summary.completedShifts}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-sm text-secondary-light">Earnings:</span>
            <span class="text-sm fw-semibold text-success-600">$${summary.totalEarnings.toFixed(2)}</span>
          </div>
        </div>
      `;
    }

    function renderRecentEntries(entries) {
      const container = document.getElementById('recentEntriesContainer');
      
      if (!entries || entries.length === 0) {
        container.innerHTML = `
          <div class="text-center">
            <div class="w-50-px h-50-px bg-secondary-50 rounded-circle d-flex justify-content-center align-items-center mx-auto mb-12">
              <iconify-icon icon="solar:history-outline" class="text-secondary-600 text-2xl"></iconify-icon>
            </div>
            <p class="text-secondary-light mb-0">No recent entries</p>
          </div>
        `;
        return;
      }

      let entriesHtml = '';
      entries.slice(0, 5).forEach(entry => {
        const clockIn = new Date(entry.clockIn);
        const clockOut = entry.clockOut ? new Date(entry.clockOut) : null;
        const duration = clockOut ? Math.round((clockOut - clockIn) / (1000 * 60)) : 'In Progress';
        
        entriesHtml += `
          <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
            <div class="flex-grow-1">
              <h6 class="mb-1 text-sm fw-semibold">${entry.title}</h6>
              <p class="mb-0 text-xs text-secondary-light">
                ${clockIn.toLocaleDateString()} • ${clockIn.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                ${clockOut ? ` - ${clockOut.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : ''}
              </p>
            </div>
            <div class="text-end">
              <span class="badge bg-${clockOut ? 'success' : 'warning'} text-sm">
                ${typeof duration === 'number' ? `${Math.floor(duration/60)}h ${duration%60}m` : duration}
              </span>
            </div>
          </div>
        `;
      });

      container.innerHTML = `
        <div class="recent-entries-list">
          ${entriesHtml}
        </div>
        ${entries.length > 5 ? `
          <div class="text-center mt-3">
            <small class="text-secondary-light">Showing 5 of ${entries.length} entries</small>
          </div>
        ` : ''}
      `;
    }

    async function refreshShifts() {
      const container = document.getElementById('shiftsContainer');
      container.innerHTML = `
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-secondary-light">Refreshing shifts...</p>
        </div>
      `;
      
      await loadUserShifts();
    }

    function showNoShiftsMessage(message) {
      const container = document.getElementById('shiftsContainer');
      container.innerHTML = `
        <div class="text-center py-5">
          <iconify-icon icon="solar:clock-circle-outline" class="icon text-4xl text-secondary-light mb-3"></iconify-icon>
          <h6 class="text-secondary-light mb-2">No Shifts Found</h6>
          <p class="text-secondary-light mb-0">${message}</p>
        </div>
      `;
    }

    // Real-time progress update functionality
    let currentShifts = []; // Store current shifts for real-time updates

    // Start real-time progress updates
    function startProgressUpdates() {
      // Update progress every 30 seconds for real-time accuracy
      progressUpdateInterval = setInterval(() => {
        updateProgressBars();
      }, 30000); // Update every 30 seconds
    }

    // Stop progress updates
    function stopProgressUpdates() {
      if (progressUpdateInterval) {
        clearInterval(progressUpdateInterval);
        progressUpdateInterval = null;
      }
    }

    // Update progress bars for in-progress shifts
    function updateProgressBars() {
      const shiftCards = document.querySelectorAll('.shift-card');
      shiftCards.forEach((card, index) => {
        const statusBadge = card.querySelector('.status-badge');
        if (statusBadge && statusBadge.classList.contains('important') && currentShifts[index]) {
          // This is an in-progress shift, update its progress
          const shift = currentShifts[index];
          const now = new Date();
          const statusInfo = getStatusInfo(shift, now);
          
          // Update progress bar
          const progressBar = card.querySelector('.progress-bar');
          if (progressBar) {
            progressBar.style.width = `${statusInfo.progress}%`;
          }
          
          // Update time remaining
          const timeRemaining = card.querySelector('.time-remaining');
          if (timeRemaining && statusInfo.timeRemaining) {
            timeRemaining.innerHTML = `
              <iconify-icon icon="solar:clock-circle-outline" class="icon text-sm"></iconify-icon>
              ${statusInfo.timeRemaining}
            `;
          }
          
          // Update status message
          const statusMessage = card.querySelector('.status-message .text-sm');
          if (statusMessage) {
            statusMessage.innerHTML = `
              <iconify-icon icon="${getStatusMessageIcon(shift.status)}" class="icon text-sm me-1"></iconify-icon>
              ${statusInfo.message}
            `;
          }
        }
      });
    }

    // Set up data reloading when authentication is restored
    function setupAuthDataReloading() {
      // Check if user data is available every 2 seconds
      const checkInterval = setInterval(() => {
        if (authService.isLoggedIn() && authService.getCurrentUser()) {
          // If we have authentication but no data, reload
          if (userShifts.length === 0) {
            console.log('Authentication restored, reloading data...');
            loadUserShifts();
            loadTimeSummary();
            loadRecentEntries();
          }
          clearInterval(checkInterval);
        }
      }, 2000);
      
      // Clear interval after 30 seconds to avoid infinite checking
      setTimeout(() => {
        clearInterval(checkInterval);
      }, 30000);
    }

    // Initialize progress updates when page loads
    document.addEventListener('DOMContentLoaded', function() {
      startProgressUpdates();
    });

    // Clean up when page unloads
    window.addEventListener('beforeunload', function() {
      stopProgressUpdates();
    });
  </script>


  <script>
    // Notification functions
    async function loadNotifications() {
      try {
        console.log('Loading notifications...');
        
        // Load unread count
        const countResponse = await maxicareAPI.getUnreadNotificationCount();
        if (countResponse && countResponse.status) {
          const countEl = document.getElementById('notificationCount');
          if (countEl) {
            countEl.textContent = countResponse.data.count;
          }
        }

        // Load recent notifications
        const notificationsResponse = await maxicareAPI.getNotifications(1, 5);
        if (notificationsResponse && notificationsResponse.status) {
          updateNotificationsList(notificationsResponse.data.notifications);
        } else {
          showNoNotificationsMessage();
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
        showNoNotificationsMessage();
      }
    }

    function updateNotificationsList(notifications) {
      const notificationsList = document.getElementById('notificationsList');
      if (!notificationsList) return;

      if (notifications.length === 0) {
        showNoNotificationsMessage();
        return;
      }

      notificationsList.innerHTML = notifications.map(notification => `
        <a href="javascript:void(0)" 
           class="px-24 py-12 d-flex align-items-start gap-3 mb-2 justify-content-between ${notification.isRead ? '' : 'bg-neutral-50'}"
           onclick="markNotificationAsRead(${notification.id})">
          <div class="text-black hover-bg-transparent hover-text-primary d-flex align-items-center gap-3">
            <span class="w-44-px h-44-px ${getNotificationIconClass(notification.type)} rounded-circle d-flex justify-content-center align-items-center flex-shrink-0">
              <iconify-icon icon="${getNotificationIcon(notification.type)}" class="icon text-xxl"></iconify-icon>
            </span>
            <div>
              <h6 class="text-md fw-semibold mb-4">${notification.title}</h6>
              <p class="mb-0 text-sm text-secondary-light text-w-200-px">${notification.message}</p>
            </div>
          </div>
          <span class="text-sm text-secondary-light flex-shrink-0">${formatTimeAgo(notification.createdAt)}</span>
        </a>
      `).join('');
    }

    function showNoNotificationsMessage() {
      const notificationsList = document.getElementById('notificationsList');
      if (!notificationsList) return;

      notificationsList.innerHTML = `
        <div class="text-center py-4">
          <iconify-icon icon="solar:bell-outline" class="icon text-4xl text-secondary-light mb-2"></iconify-icon>
          <p class="text-secondary-light mb-0">No notifications</p>
        </div>
      `;
    }

    function getNotificationIcon(type) {
      const iconMap = {
        'shift_assigned': 'solar:clock-circle-outline',
        'shift_completed': 'solar:check-circle-outline',
        'shift_cancelled': 'solar:close-circle-outline',
        'user_registered': 'solar:user-plus-outline',
        'system_announcement': 'solar:megaphone-outline',
        'shift_reminder': 'solar:alarm-outline',
        'payment_processed': 'solar:wallet-outline',
        'profile_updated': 'solar:user-outline',
        'password_changed': 'solar:lock-outline',
        'login_attempt': 'solar:login-3-outline'
      };
      return iconMap[type] || 'solar:bell-outline';
    }

    function getNotificationIconClass(type) {
      const classMap = {
        'shift_assigned': 'bg-primary-subtle text-primary-main',
        'shift_completed': 'bg-success-subtle text-success-main',
        'shift_cancelled': 'bg-danger-subtle text-danger-main',
        'user_registered': 'bg-info-subtle text-info-main',
        'system_announcement': 'bg-warning-subtle text-warning-main',
        'shift_reminder': 'bg-warning-subtle text-warning-main',
        'payment_processed': 'bg-success-subtle text-success-main',
        'profile_updated': 'bg-info-subtle text-info-main',
        'password_changed': 'bg-warning-subtle text-warning-main',
        'login_attempt': 'bg-info-subtle text-info-main'
      };
      return classMap[type] || 'bg-secondary-subtle text-secondary-main';
    }

    async function markNotificationAsRead(notificationId) {
      try {
        await maxicareAPI.markNotificationAsRead(notificationId);
        // Reload notifications to update the UI
        await loadNotifications();
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    function formatTimeAgo(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      const now = new Date();
      const diffInMinutes = Math.floor((now - date) / (1000 * 60));
      if (diffInMinutes < 1) return 'Just now';
      if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
      if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;
      return `${Math.floor(diffInMinutes / 1440)}d ago`;
    }
  </script>
</body>

</html>
