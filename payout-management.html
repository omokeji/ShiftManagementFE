<!-- meta tags and other links -->
<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payout Management - MaxiCare Admin</title>
  <link rel="icon" type="image/png" href="assets/images/favicon.png" sizes="16x16">
  <!-- remix icon font css  -->
  <link rel="stylesheet" href="assets/css/remixicon.css">
  <!-- BootStrap css -->
  <link rel="stylesheet" href="assets/css/lib/bootstrap.min.css">
  <!-- Apex Chart css -->
  <link rel="stylesheet" href="assets/css/lib/apexcharts.css">
  <!-- Data Table css -->
  <link rel="stylesheet" href="assets/css/lib/dataTables.min.css">
  <!-- Text Editor css -->
  <link rel="stylesheet" href="assets/css/lib/editor-katex.min.css">
  <link rel="stylesheet" href="assets/css/lib/editor.atom-one-dark.min.css">
  <link rel="stylesheet" href="assets/css/lib/editor.quill.snow.css">
  <!-- Date picker css -->
  <link rel="stylesheet" href="assets/css/lib/flatpickr.min.css">
  <!-- Calendar css -->
  <link rel="stylesheet" href="assets/css/lib/full-calendar.css">
  <!-- Vector Map css -->
  <link rel="stylesheet" href="assets/css/lib/jquery-jvectormap-2.0.5.css">
  <!-- Popup css -->
  <link rel="stylesheet" href="assets/css/lib/magnific-popup.css">
  <!-- Slick Slider css -->
  <link rel="stylesheet" href="assets/css/lib/slick.css">
  <!-- prism css -->
  <link rel="stylesheet" href="assets/css/lib/prism.css">
  <!-- file upload css -->
  <link rel="stylesheet" href="assets/css/lib/file-upload.css">
  <link rel="stylesheet" href="assets/css/lib/audioplayer.css">
  <!-- main css -->
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- shift management css -->
  <link rel="stylesheet" href="assets/css/shift-management.css">
    <style>
        .payout-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .payout-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            font-weight: 600;
        }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-processing { background-color: #17a2b8; color: #fff; }
        .status-completed { background-color: #28a745; color: #fff; }
        .status-failed { background-color: #dc3545; color: #fff; animation: pulse 2s infinite; }
        .status-cancelled { background-color: #6c757d; color: #fff; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .type-early { border-left-color: #fd7e14; }
        .type-regular { border-left-color: #007bff; }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .summary-card .card-body {
            padding: 1.5rem;
        }
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        /* Notification Badge Styles */
        #notificationBadge {
            font-size: 0.65rem;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }
    </style>
</head>
<body>
  <aside class="sidebar">
    <button type="button" class="sidebar-close-btn">
      <iconify-icon icon="radix-icons:cross-2"></iconify-icon>
    </button>
    <div>
      <a href="index.html" class="sidebar-logo">
        <img src="assets/images/logo.png" alt="site logo" class="light-logo">
        <img src="assets/images/logo-light.png" alt="site logo" class="dark-logo">
        <img src="assets/images/logo-icon.png" alt="site logo" class="logo-icon">
      </a>
    </div>
    <div class="sidebar-menu-area">
      <ul class="sidebar-menu" id="sidebar-menu">
        <li>
          <a href="index.html">
            <iconify-icon icon="solar:home-smile-angle-outline" class="menu-icon"></iconify-icon>
            <span>Dashboard</span>
                            </a>
                        </li>
        <li>
          <a href="javascript:void(0)" class="disabled-link" style="opacity: 0.5; cursor: not-allowed;">
            <iconify-icon icon="solar:calendar-outline" class="menu-icon"></iconify-icon>
            <span>Calendar (Disabled)</span>
                            </a>
                        </li>
        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <iconify-icon icon="flowbite:users-group-outline" class="menu-icon"></iconify-icon>
            <span>Users</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="users-list.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Users List</a>
                        </li>
            <li>
              <a href="add-user.html"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> Add User</a>
            </li>
            <li>
              <a href="view-profile.html"><i class="ri-circle-fill circle-icon text-danger-main w-auto"></i> View Profile</a>
            </li>
          </ul>
        </li>

        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <i class="ri-user-settings-line text-xl me-14 d-flex w-auto"></i>
            <span>Role & Access</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="role-access.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Role & Access</a>
                        </li>
            <li>
              <a href="assign-role.html"><i class="ri-circle-fill circle-icon text-warning-main w-auto"></i> Assign Role</a>
            </li>
          </ul>
        </li>

        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <iconify-icon icon="solar:clock-circle-outline" class="menu-icon"></iconify-icon>
            <span>Shift Management</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="add-shift.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Add Shift</a>
            </li>
            <li>
              <a href="view-shifts.html"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> View Shifts</a>
            </li>
          <li>
            <a href="clock-change-requests.html"><i class="ri-circle-fill circle-icon text-warning-main w-auto"></i> Clock Change Requests</a>
          </li>
          <li>
            <a href="javascript:void(0)" onclick="showShiftReports()"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> Shift Reports</a>
          </li>
        </ul>
      </li>

        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <iconify-icon icon="solar:briefcase-outline" class="menu-icon"></iconify-icon>
            <span>Job Types</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="job-types.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Job Types List</a>
            </li>
            <li>
              <a href="add-job-type.html"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> Add Job Type</a>
            </li>
          </ul>
        </li>

        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <iconify-icon icon="solar:dollar-minimalistic-outline" class="menu-icon"></iconify-icon>
            <span>Payout Management</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="payout-management.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Payout Management</a>
            </li>
          </ul>
        </li>

        <li class="employee-only">
          <a href="my-shifts.html">
            <iconify-icon icon="solar:clock-circle-outline" class="menu-icon"></iconify-icon>
            <span>My Shifts</span>
          </a>
        </li>

        <li class="employee-only">
          <a href="available-shifts.html">
            <iconify-icon icon="solar:calendar-add-outline" class="menu-icon"></iconify-icon>
            <span>Available Shifts</span>
                            </a>
                        </li>
                    </ul>
                </div>
  </aside>

  <main class="dashboard-main">
    <div class="navbar-header">
      <div class="row align-items-center justify-content-between">
        <div class="col-auto">
          <div class="d-flex flex-wrap align-items-center gap-4">
            <button type="button" class="sidebar-toggle">
              <iconify-icon icon="heroicons:bars-3-solid" class="icon text-2xl non-active"></iconify-icon>
              <iconify-icon icon="iconoir:arrow-right" class="icon text-2xl active"></iconify-icon>
            </button>
            <button type="button" class="sidebar-mobile-toggle">
              <iconify-icon icon="heroicons:bars-3-solid" class="icon"></iconify-icon>
            </button>
            <form class="navbar-search">
              <input type="text" name="search" placeholder="Search">
              <iconify-icon icon="ion:search-outline" class="icon"></iconify-icon>
            </form>
          </div>
        </div>
        <div class="col-auto">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <button type="button" data-theme-toggle
              class="w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"></button>

            <div class="dropdown">
              <button
                class="has-indicator w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center position-relative"
                type="button" data-bs-toggle="dropdown">
                <iconify-icon icon="iconoir:bell" class="text-primary-light text-xl"></iconify-icon>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                  0
                </span>
              </button>
              <div class="dropdown-menu to-top dropdown-menu-lg p-0">
                <div
                  class="m-16 py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
                  <div>
                    <h6 class="text-lg text-primary-light fw-semibold mb-0">Notifications</h6>
                  </div>
                  <span
                    class="text-primary-600 fw-semibold text-lg w-40-px h-40-px rounded-circle bg-base d-flex justify-content-center align-items-center" id="notificationCount">0</span>
                </div>

                <div class="max-h-400-px overflow-y-auto scroll-sm pe-4" id="notificationsList">
                  <!-- Notifications will be loaded here -->
                  <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-secondary-light text-sm">Loading notifications...</p>
                  </div>
                </div>

                <div class="text-center py-12 px-16">
                  <a href="javascript:void(0)" class="text-primary-600 fw-semibold text-md">See All Notification</a>
                </div>

              </div>
            </div><!-- Notification dropdown end -->

            <div class="dropdown">
              <button class="d-flex justify-content-center align-items-center rounded-circle" type="button"
                data-bs-toggle="dropdown">
                <img src="assets/images/user.png" alt="image" class="w-40-px h-40-px object-fit-cover rounded-circle">
              </button>
              <div class="dropdown-menu to-top dropdown-menu-sm">
                <div
                  class="py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
                  <div>
                    <h6 class="text-lg text-primary-light fw-semibold mb-2 user-name">Loading...</h6>
                    <span class="text-secondary-light fw-medium text-sm user-role">Loading...</span>
                  </div>
                  <button type="button" class="hover-text-danger">
                    <iconify-icon icon="radix-icons:cross-1" class="icon text-xl"></iconify-icon>
                  </button>
                </div>
                <ul class="to-top-list">
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3"
                      href="view-profile.html">
                      <iconify-icon icon="solar:user-linear" class="icon text-xl"></iconify-icon> My Profile</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3"
                      href="email.html">
                      <iconify-icon icon="tabler:message-check" class="icon text-xl"></iconify-icon> Inbox</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3"
                      href="company.html">
                      <iconify-icon icon="icon-park-outline:setting-two" class="icon text-xl"></iconify-icon>
                      Setting</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-danger d-flex align-items-center gap-3"
                      href="javascript:void(0)" id="logoutBtn">
                      <iconify-icon icon="lucide:power" class="icon text-xl"></iconify-icon> Log Out</a>
                  </li>
                </ul>
              </div>
            </div><!-- Profile dropdown end -->
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-main-body">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <h6 class="fw-semibold mb-0">Payout Management</h6>
        <ul class="d-flex align-items-center gap-2">
          <li class="fw-medium">
            <a href="index.html" class="d-flex align-items-center gap-1 hover-text-primary">
              <iconify-icon icon="solar:home-smile-angle-outline" class="icon text-lg"></iconify-icon>
              Dashboard
            </a>
          </li>
          <li>-</li>
          <li class="fw-medium">Payout Management</li>
        </ul>
      </div>

      <!-- Dashboard Cards -->
      <div class="row row-cols-xxl-4 row-cols-xl-3 row-cols-lg-2 row-cols-md-2 row-cols-sm-1 row-cols-1 gy-4 mb-24">
        <div class="col">
          <div class="card shadow-none border bg-gradient-primary h-100">
            <div class="card-body p-20">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div>
                  <p class="fw-medium text-white mb-1">Total Payouts</p>
                  <h6 class="mb-0 text-white" id="totalPayouts">-</h6>
                </div>
                <div class="w-50-px h-50-px bg-white bg-opacity-20 rounded-circle d-flex justify-content-center align-items-center">
                  <iconify-icon icon="solar:dollar-minimalistic-outline" class="text-white text-xl"></iconify-icon>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col">
          <div class="card shadow-none border bg-gradient-success h-100">
            <div class="card-body p-20">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div>
                  <p class="fw-medium text-white mb-1">Total Amount</p>
                  <h6 class="mb-0 text-white" id="totalAmount">-</h6>
                </div>
                <div class="w-50-px h-50-px bg-white bg-opacity-20 rounded-circle d-flex justify-content-center align-items-center">
                  <iconify-icon icon="solar:bill-list-outline" class="text-white text-xl"></iconify-icon>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col">
          <div class="card shadow-none border bg-gradient-warning h-100">
            <div class="card-body p-20">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div>
                  <p class="fw-medium text-white mb-1">Pending Requests</p>
                  <h6 class="mb-0 text-white" id="pendingRequests">-</h6>
                </div>
                <div class="w-50-px h-50-px bg-white bg-opacity-20 rounded-circle d-flex justify-content-center align-items-center">
                  <iconify-icon icon="solar:clock-circle-outline" class="text-white text-xl"></iconify-icon>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col">
          <div class="card shadow-none border bg-gradient-info h-100">
            <div class="card-body p-20">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div>
                  <p class="fw-medium text-white mb-1">Completed Shifts</p>
                  <h6 class="mb-0 text-white" id="completedShifts">-</h6>
                </div>
                <div class="w-50-px h-50-px bg-white bg-opacity-20 rounded-circle d-flex justify-content-center align-items-center">
                  <iconify-icon icon="solar:check-circle-outline" class="text-white text-xl"></iconify-icon>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <div class="d-flex flex-wrap align-items-center gap-3">
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPayoutModal">
            <iconify-icon icon="solar:add-circle-outline" class="icon text-lg me-2"></iconify-icon>
            Create Payout
          </button>
          <button type="button" class="btn btn-success" onclick="processWeeklyPayouts()">
            <iconify-icon icon="solar:calendar-outline" class="icon text-lg me-2"></iconify-icon>
            Process Weekly Payouts
          </button>
          <button type="button" class="btn btn-info" onclick="loadCompletedShifts()">
            <iconify-icon icon="solar:refresh-outline" class="icon text-lg me-2"></iconify-icon>
            Refresh Data
          </button>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-3">
          <div class="form-group">
            <select class="form-select" id="statusFilter" onchange="filterPayoutRequests()">
              <option value="">All Status</option>
                                <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
              <option value="processed">Processed</option>
                            </select>
                        </div>
                        </div>
                        </div>

      <!-- Completed Shifts Section -->
      <div class="row mb-24">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                <h5 class="card-title mb-0">
                  <iconify-icon icon="solar:check-circle-outline" class="icon text-lg me-2"></iconify-icon>
                  Completed Shifts Ready for Payout
                </h5>
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="badge bg-success" id="completedShiftsCount">0</span>
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadCompletedShifts()">
                    <iconify-icon icon="solar:refresh-outline" class="icon text-sm"></iconify-icon>
                    Refresh
                  </button>
                        </div>
                    </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Shift ID</th>
                      <th>Title</th>
                      <th>Employee</th>
                      <th>Date</th>
                      <th>Hours Worked</th>
                      <th>Hourly Rate</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="completedShiftsTableBody">
                    <tr>
                      <td colspan="9" class="text-center">Loading completed shifts...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payout Request Management Section -->
      <div class="row mb-24">
                        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                <h5 class="card-title mb-0">
                  <iconify-icon icon="solar:clock-circle-outline" class="icon text-lg me-2"></iconify-icon>
                  Employee Payout Requests
                </h5>
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="badge bg-warning" id="pendingRequestsCount">0</span>
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadPayoutRequests()">
                    <iconify-icon icon="solar:refresh-outline" class="icon text-sm"></iconify-icon>
                    Refresh
                            </button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Request ID</th>
                      <th>Employee</th>
                      <th>Shift</th>
                      <th>Amount</th>
                      <th>Type</th>
                      <th>Status</th>
                      <th>Requested</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="payoutRequestsTableBody">
                    <tr>
                      <td colspan="8" class="text-center">Loading payout requests...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
                        </div>
                    </div>
                </div>

      <!-- Existing Payouts Section -->
      <div class="row mb-24">
        <div class="col-12">
                <div class="card">
                    <div class="card-header">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                <h5 class="card-title mb-0">
                  <iconify-icon icon="solar:dollar-minimalistic-outline" class="icon text-lg me-2"></iconify-icon>
                  All Payouts
                </h5>
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadPayouts()">
                    <iconify-icon icon="solar:refresh-outline" class="icon text-sm"></iconify-icon>
                    Refresh
                  </button>
                </div>
              </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                      <th>Payout ID</th>
                                        <th>Employee</th>
                                        <th>Shift</th>
                                        <th>Amount</th>
                                        <th>Type</th>
                      <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payoutsTableBody">
                    <tr>
                      <td colspan="8" class="text-center">Loading payouts...</td>
                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <div class="d-flex justify-content-center mt-3">
                            <nav aria-label="Payouts pagination">
                                <ul class="pagination" id="pagination">
                                    <!-- Pagination items will be inserted here by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    </div>
  </main>

    <!-- Create Payout Modal -->
    <div class="modal fade" id="createPayoutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Payout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createPayoutForm">
                        <div class="mb-3">
                            <label for="employeeSelect" class="form-label">Employee</label>
                            <select class="form-select" id="employeeSelect" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="shiftSelect" class="form-label">Completed Shift</label>
                            <select class="form-select" id="shiftSelect" required>
                                <option value="">Select Shift</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isEarlyPayout">
                                <label class="form-check-label" for="isEarlyPayout">
                                    Early Payout (Less than 7 days - $5 fee applies)
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createPayout()">Create Payout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Payout Modal -->
    <div class="modal fade" id="processPayoutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Process Payout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="processPayoutForm">
                        <input type="hidden" id="processPayoutId">
                        <div class="mb-3">
                            <label for="stripeAccountId" class="form-label">Stripe Account ID (Optional)</label>
                            <input type="text" class="form-control" id="stripeAccountId" placeholder="acct_...">
                            <div class="form-text">Leave empty to process without Stripe integration</div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> This will process the payout and mark it as completed.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="processPayout()">Process Payout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">
                        <iconify-icon icon="solar:question-circle-bold" class="icon text-warning me-2"></iconify-icon>
                        <span id="confirmModalTitle">Confirm Action</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage" class="mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <iconify-icon icon="solar:close-circle-outline" class="icon me-1"></iconify-icon>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmModalBtn">
                        <iconify-icon icon="solar:check-circle-outline" class="icon me-1"></iconify-icon>
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

  <script src="assets/js/lib/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap js -->
  <script src="assets/js/lib/bootstrap.bundle.min.js"></script>
  <!-- Apex Chart js -->
  <script src="assets/js/lib/apexcharts.min.js"></script>
  <!-- Data Table js -->
  <script src="assets/js/lib/dataTables.min.js"></script>
  <!-- Iconify Font js -->
  <script src="assets/js/lib/iconify-icon.min.js"></script>
  <!-- jQuery UI js -->
  <script src="assets/js/lib/jquery-ui.min.js"></script>
  <!-- Vector Map js -->
  <script src="assets/js/lib/jquery-jvectormap-2.0.5.min.js"></script>
  <script src="assets/js/lib/jquery-jvectormap-world-mill-en.js"></script>
  <!-- Popup js -->
  <script src="assets/js/lib/magnifc-popup.min.js"></script>
  <!-- Slick Slider js -->
  <script src="assets/js/lib/slick.min.js"></script>
  <!-- prism js -->
  <script src="assets/js/lib/prism.js"></script>
  <!-- file upload js -->
  <script src="assets/js/lib/file-upload.js"></script>
  <!-- audioplayer -->
  <script src="assets/js/lib/audioplayer.js"></script>

  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/router.js"></script>
  <script src="assets/js/profile-picture.js"></script>
  <!-- main js -->
  <script src="assets/js/app.js"></script>
    <script>
        let currentPage = 1;
        let currentFilters = {};

        // Show confirmation modal and return a promise
        function showConfirmModal(title, message, confirmBtnText = 'Confirm', confirmBtnClass = 'btn-primary') {
            return new Promise((resolve) => {
                const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                const modalTitle = document.getElementById('confirmModalTitle');
                const modalMessage = document.getElementById('confirmModalMessage');
                const confirmBtn = document.getElementById('confirmModalBtn');
                
                // Set content
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmBtn.textContent = confirmBtnText;
                
                // Reset button classes
                confirmBtn.className = 'btn ' + confirmBtnClass;
                
                // Handle confirm
                const handleConfirm = () => {
                    modal.hide();
                    resolve(true);
                    confirmBtn.removeEventListener('click', handleConfirm);
                };
                
                // Handle cancel/close
                const handleCancel = () => {
                    resolve(false);
                    confirmBtn.removeEventListener('click', handleConfirm);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                document.getElementById('confirmationModal').addEventListener('hidden.bs.modal', handleCancel, { once: true });
                
                // Show modal
                modal.show();
            });
        }

        // Test API connection
        async function testAPIConnection() {
            try {
                console.log('Testing API connection...');
                // Try to get payout summary as a test
                const response = await maxicareAPI.getPayoutSummary();
                console.log('API connection test result:', response);
                return true;
            } catch (error) {
                console.error('API connection test failed:', error);
                // If the specific endpoint fails, try a basic request
                try {
                    const basicResponse = await maxicareAPI.request('/api/payouts', { method: 'GET' });
                    console.log('Basic API test result:', basicResponse);
                    return true;
                } catch (basicError) {
                    console.error('Basic API test also failed:', basicError);
                    return false;
                }
            }
        }

        // Debug function to check if elements exist
        function debugElements() {
            console.log('=== DEBUGGING ELEMENTS ===');
            console.log('Sidebar element:', document.querySelector('.sidebar'));
            console.log('Dashboard cards:');
            console.log('- totalPayouts:', document.getElementById('totalPayouts'));
            console.log('- totalAmount:', document.getElementById('totalAmount'));
            console.log('- pendingRequests:', document.getElementById('pendingRequests'));
            console.log('- completedShifts:', document.getElementById('completedShifts'));
            console.log('Table bodies:');
            console.log('- completedShiftsTableBody:', document.getElementById('completedShiftsTableBody'));
            console.log('- payoutRequestsTableBody:', document.getElementById('payoutRequestsTableBody'));
            console.log('- payoutsTableBody:', document.getElementById('payoutsTableBody'));
            console.log('========================');
        }

        // Setup role-based access
        function setupRoleBasedAccess() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('maxicare_user') || sessionStorage.getItem('maxicare_user') || '{}');
                if (!currentUser || !currentUser.role) {
                    console.log('No current user found');
                    return;
                }

                const isAdmin = currentUser.role === 'admin' || currentUser.role === 'administrator';
                const isUser = currentUser.role === 'user' || currentUser.role === 'employee';

                console.log('User role:', currentUser.role, 'isAdmin:', isAdmin, 'isUser:', isUser);

                // Show/hide admin-only elements
                const adminElements = document.querySelectorAll('.admin-only');
                adminElements.forEach(element => {
                    element.style.display = isAdmin ? 'block' : 'none';
                });

                // Show/hide employee-only elements
                const employeeElements = document.querySelectorAll('.employee-only');
                employeeElements.forEach(element => {
                    element.style.display = isUser ? 'block' : 'none';
                });

                // Update user info in topbar
                const userNameElement = document.querySelector('.user-name');
                const userRoleElement = document.querySelector('.user-role');
                
                if (userNameElement) {
                    userNameElement.textContent = `${currentUser.firstname || ''} ${currentUser.lastname || ''}`.trim() || currentUser.username || 'User';
                }
                
                if (userRoleElement) {
                    userRoleElement.textContent = currentUser.role || 'User';
                }

                // If user is not admin, redirect to appropriate page
                if (!isAdmin) {
                    console.log('User is not admin, redirecting to employee dashboard');
                    window.location.href = 'employee-dashboard.html';
                    return;
                }

            } catch (error) {
                console.error('Error setting up role-based access:', error);
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await maxicareAPI.getNotifications(parseInt(1), parseInt(10));
                if (response.status) {
                    displayNotifications(response.data.notifications || []);
                    updateNotificationCount(response.data.unreadCount || 0);
                } else {
                    console.error('Failed to load notifications:', response.message);
                    displayNotifications([]);
                    updateNotificationCount(0);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                displayNotifications([]);
                updateNotificationCount(0);
            }
        }

        // Display notifications in dropdown
        function displayNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) return;

            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="text-center py-3">
                        <iconify-icon icon="solar:bell-off-outline" class="icon text-2xl text-secondary-light mb-2"></iconify-icon>
                        <p class="text-secondary-light text-sm mb-0">No notifications</p>
                    </div>
                `;
                return;
            }

            notificationsList.innerHTML = notifications.map(notification => `
                <div class="notification-item p-12 border-bottom border-light hover-bg-light cursor-pointer" 
                     onclick="markNotificationAsRead(${notification.id})">
                    <div class="d-flex align-items-start gap-3">
                        <div class="w-8-px h-8-px rounded-circle ${notification.isRead ? 'bg-secondary-light' : 'bg-primary'} mt-1"></div>
                        <div class="flex-grow-1">
                            <h6 class="text-sm fw-semibold mb-1 ${notification.isRead ? 'text-secondary-light' : 'text-dark'}">
                                ${notification.title || 'Notification'}
                            </h6>
                            <p class="text-xs text-secondary-light mb-1">
                                ${notification.message || 'No message'}
                            </p>
                            <span class="text-xs text-secondary-light">
                                ${new Date(notification.createdAt).toLocaleString()}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update notification count
        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notificationCount');
            if (notificationCount) {
                notificationCount.textContent = count;
                notificationCount.style.display = count > 0 ? 'flex' : 'none';
            }
            
            // Update badge indicator on bell icon
            const notificationBadge = document.getElementById('notificationBadge');
            if (notificationBadge) {
                if (count > 0) {
                    notificationBadge.textContent = count > 99 ? '99+' : count;
                    notificationBadge.style.display = 'block';
                } else {
                    notificationBadge.style.display = 'none';
                }
            }
        }

        // Mark notification as read
        async function markNotificationAsRead(notificationId) {
            try {
                await maxicareAPI.markNotificationAsRead(notificationId);
                // Reload notifications to update the UI
                loadNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Payout Management page loaded');
            console.log('MaxiCare API available:', typeof maxicareAPI !== 'undefined');
            
            // Debug elements
            debugElements();
            
            // Authentication check
            const hasToken = localStorage.getItem('maxicare_token') || sessionStorage.getItem('maxicare_token');
            const hasUser = localStorage.getItem('maxicare_user') || sessionStorage.getItem('maxicare_user');
            
            console.log('Authentication check:', {
                hasToken: !!hasToken,
                hasUser: !!hasUser
            });
            
            if (!hasToken || !hasUser) {
                console.log('No authentication data found, redirecting to sign-in');
                window.location.href = 'sign-in.html';
                return;
            }
            
            // Setup role-based access
            setupRoleBasedAccess();
            
            // Test API connection first
            testAPIConnection().then(connected => {
                if (!connected) {
                    showAlert('Unable to connect to the server. Please check your connection.', 'danger');
                    return;
                }
                
                // Load data with error handling
                Promise.all([
                    loadPayoutSummary().catch(err => console.error('Error loading payout summary:', err)),
                    loadPayouts().catch(err => console.error('Error loading payouts:', err)),
                    loadEmployees().catch(err => console.error('Error loading employees:', err)),
                    loadCompletedShifts().catch(err => console.error('Error loading completed shifts:', err)),
                    loadPayoutRequests().catch(err => console.error('Error loading payout requests:', err)),
                    loadNotifications().catch(err => console.error('Error loading notifications:', err))
                ]).then(() => {
                    console.log('All data loaded successfully');
                }).catch(err => {
                    console.error('Error loading data:', err);
                    showAlert('Error loading page data', 'danger');
                });
            });
        });

        // Logout functionality
        document.addEventListener('click', function(e) {
            if (e.target.closest('#logoutBtn')) {
                e.preventDefault();
                logout();
            }
        });

        // Notification dropdown click handler
        document.addEventListener('click', function(e) {
            if (e.target.closest('[data-bs-toggle="dropdown"]') && e.target.closest('[data-bs-toggle="dropdown"]').querySelector('iconify-icon[icon="iconoir:bell"]')) {
                // Refresh notifications when dropdown is opened
                loadNotifications();
            }
        });

        function logout() {
            try {
                // Clear authentication data
                localStorage.removeItem('maxicare_token');
                localStorage.removeItem('maxicare_user');
                sessionStorage.removeItem('maxicare_token');
                sessionStorage.removeItem('maxicare_user');
                
                // Clear any other auth-related data
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                
                console.log('User logged out successfully');
                
                // Redirect to sign-in page
                window.location.href = 'sign-in.html';
            } catch (error) {
                console.error('Error during logout:', error);
                // Force redirect even if there's an error
                window.location.href = 'sign-in.html';
            }
        }

        // Show alert function
        function showAlert(message, type = 'info') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add to page
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Load payout summary
        async function loadPayoutSummary() {
            try {
                const response = await maxicareAPI.getPayoutSummary();
                if (response.status) {
                    const summary = response.data;
                    document.getElementById('totalPayouts').textContent = summary.totalPayouts || 0;
                    document.getElementById('totalAmount').textContent = `$${(summary.totalAmount || 0).toFixed(2)}`;
                    document.getElementById('pendingRequests').textContent = summary.pendingPayouts || 0;
                    document.getElementById('completedShifts').textContent = summary.completedPayouts || 0;
                }
            } catch (error) {
                console.error('Error loading payout summary:', error);
                showAlert('Error loading payout summary', 'danger');
            }
        }

        // Load payouts
        async function loadPayouts(page = 1) {
            try {
                const filters = { 
                    ...currentFilters, 
                    page: parseInt(page), 
                    limit: parseInt(10) 
                };
                const response = await maxicareAPI.getPayouts(filters);
                
                if (response.status) {
                    displayPayouts(response.data.payouts);
                    updatePagination(response.data.total, page);
                }
            } catch (error) {
                console.error('Error loading payouts:', error);
                showAlert('Error loading payouts', 'danger');
            }
        }

        // Display payouts in table
        function displayPayouts(payouts) {
            const tbody = document.getElementById('payoutsTableBody');
            tbody.innerHTML = '';

            if (payouts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No payouts found</td></tr>';
                return;
            }

            payouts.forEach(payout => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payout.id}</td>
                    <td>${payout.user ? `${payout.user.firstname} ${payout.user.lastname}` : 'N/A'}</td>
                    <td>${payout.shift ? payout.shift.title : 'N/A'}</td>
                    <td>$${parseFloat(payout.amount).toFixed(2)}</td>
                    <td>$${parseFloat(payout.netAmount).toFixed(2)}</td>
                    <td>${(payout.totalHoursWorked / 60).toFixed(2)}h</td>
                    <td><span class="badge status-badge status-${payout.status}">${payout.status}</span></td>
                    <td><span class="badge ${payout.type === 'early' ? 'bg-warning' : 'bg-info'}">${payout.type}</span></td>
                    <td>${new Date(payout.createdAt).toLocaleDateString()}</td>
                    <td>
                        ${payout.status === 'pending' ? 
                            `<button class="btn btn-sm btn-success" onclick="openProcessModal(${payout.id})">
                                <iconify-icon icon="solar:play-outline" class="icon"></iconify-icon> Process
                            </button>` : 
                            payout.status === 'failed' ?
                            `<button class="btn btn-sm btn-warning" onclick="retryFailedPayout(${payout.id})">
                                <iconify-icon icon="solar:refresh-outline" class="icon"></iconify-icon> Retry
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewPayoutDetails(${payout.id})">
                                <iconify-icon icon="solar:eye-outline" class="icon"></iconify-icon> View
                            </button>` :
                            `<button class="btn btn-sm btn-info" onclick="viewPayoutDetails(${payout.id})">
                                <iconify-icon icon="solar:eye-outline" class="icon"></iconify-icon> View
                            </button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update pagination
        function updatePagination(total, currentPage) {
            const pagination = document.getElementById('pagination');
            
            // Check if pagination element exists
            if (!pagination) {
                console.warn('Pagination element not found');
                return;
            }
            
            const totalPages = Math.ceil(total / 10);
            
            pagination.innerHTML = '';
            
            // Don't show pagination if only one page
            if (totalPages <= 1) {
                return;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="loadPayouts(${i}); return false;">${i}</a>`;
                pagination.appendChild(li);
            }
        }

        // Apply filters
        function applyFilters() {
            currentFilters = {
                status: document.getElementById('statusFilter').value,
                type: document.getElementById('typeFilter').value,
                startDate: document.getElementById('startDateFilter').value,
                endDate: document.getElementById('endDateFilter').value
            };

            // Remove empty filters
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) {
                    delete currentFilters[key];
                }
            });

            currentPage = 1;
            loadPayouts();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            currentFilters = {};
            currentPage = 1;
            loadPayouts();
        }

        // Load employees for dropdown
        async function loadEmployees() {
            try {
                const response = await maxicareAPI.getUsers();
                if (response.status) {
                    const select = document.getElementById('employeeSelect');
                    select.innerHTML = '<option value="">Select Employee</option>';
                    
                    response.data.forEach(user => {
                        if (user.role === 'user') {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.firstname} ${user.lastname}`;
                            select.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        // Load completed shifts for dropdown and display (ALL employees for admin)
        async function loadCompletedShifts() {
            try {
                console.log('Loading completed shifts for all employees...');
                // Admin side: Load ALL completed shifts (no userId parameter)
                const response = await maxicareAPI.getCompletedShiftsForPayout();
                console.log('Completed shifts response:', response);
                
                if (response.status) {
                    const shifts = response.data || [];
                    console.log('Completed shifts data (all employees):', shifts);
                    
                    // Display completed shifts in table
                    displayCompletedShifts(shifts);
                    
                    const countElement = document.getElementById('completedShiftsCount');
                    if (countElement) {
                        countElement.textContent = shifts.length;
                    }
                } else {
                    console.error('Failed to load completed shifts:', response.message);
                    showAlert('Failed to load completed shifts: ' + (response.message || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error loading completed shifts:', error);
                showAlert('Error loading completed shifts: ' + error.message, 'danger');
            }
        }

        // Display completed shifts in table (with employee names for admin view)
        function displayCompletedShifts(shifts) {
            const tbody = document.getElementById('completedShiftsTableBody');
            
            console.log('Displaying completed shifts:', shifts);
            
            if (!tbody) {
                console.error('Table body element not found');
                return;
            }
            
            if (!shifts || shifts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No completed shifts found</td></tr>';
                return;
            }

            try {
                tbody.innerHTML = shifts.map(shift => {
                    console.log('Processing shift:', shift);
                    
                    // Convert totalHoursWorked from minutes to hours
                    const hoursWorked = shift.totalHoursWorked ? (shift.totalHoursWorked / 60).toFixed(2) : '0.00';
                    
                    // Get hourly rate - convert string to number, prioritize shift.hourlyRate
                    const hourlyRateStr = shift.shift?.hourlyRate || shift.hourlyRate || '0';
                    const hourlyRate = parseFloat(hourlyRateStr) || 0;
                    
                    // Calculate amount
                    const amount = (parseFloat(hoursWorked) * hourlyRate).toFixed(2);
                    
                    // Get employee name from the shift data
                    const employeeName = shift.user ? 
                        `${shift.user.firstname} ${shift.user.lastname}` : 
                        'Unknown Employee';
                    
                    const shiftId = shift.shiftId || shift.id;
                    const shiftTitle = shift.shift?.title || shift.title || 'N/A';
                    const shiftDate = shift.shift?.date || shift.date;
                    const clockInRecordId = shift.clockInRecordId;
                    
                    // Determine which button to show based on approval status
                    let actionButton;
                    if (shift.isApproved) {
                        // Show "Create Payout" button if already approved
                        actionButton = `
                            <button class="btn btn-sm btn-primary" onclick="createPayoutForShift(${shiftId}, ${shift.userId})">
                                <iconify-icon icon="solar:dollar-minimalistic-outline" class="icon text-sm"></iconify-icon>
                                Create Payout
                            </button>
                        `;
                    } else if (shift.needsApproval) {
                        // Show "Approve" button if needs approval
                        actionButton = `
                            <button class="btn btn-sm btn-warning" onclick="approveClockInForPayout(${clockInRecordId}, ${shiftId}, ${shift.userId})">
                                <iconify-icon icon="solar:check-circle-outline" class="icon text-sm"></iconify-icon>
                                Approve Clock-in
                            </button>
                        `;
                    } else {
                        // Default to create payout
                        actionButton = `
                            <button class="btn btn-sm btn-primary" onclick="createPayoutForShift(${shiftId}, ${shift.userId})">
                                <iconify-icon icon="solar:dollar-minimalistic-outline" class="icon text-sm"></iconify-icon>
                                Create Payout
                            </button>
                        `;
                    }
                    
                    return `
                        <tr data-clockin-id="${clockInRecordId}">
                            <td>${shiftId}</td>
                            <td>${shiftTitle}</td>
                            <td>${employeeName}</td>
                            <td>${new Date(shiftDate).toLocaleDateString()}</td>
                            <td>${hoursWorked} hrs</td>
                            <td>$${hourlyRate.toFixed(2)}/hr</td>
                            <td>$${amount}</td>
                            <td><span class="badge ${shift.isApproved ? 'bg-success' : 'bg-warning'}">
                                ${shift.isApproved ? 'Approved' : 'Pending Approval'}
                            </span></td>
                            <td>
                                ${actionButton}
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error displaying completed shifts:', error);
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error displaying shifts data</td></tr>';
            }
        }

        // Create payout for specific shift
        // Approve clock-in record for payout
        async function approveClockInForPayout(clockInRecordId, shiftId, userId) {
            const confirmed = await showConfirmModal(
                'Approve Clock-in',
                'Are you sure you want to approve this clock-in record for payout processing?',
                'Approve',
                'btn-warning'
            );
            
            if (!confirmed) return;
            
            try {
                showAlert('Approving clock-in...', 'info');
                
                await maxicareAPI.approveClockInForPayout(clockInRecordId);
                
                showAlert('Clock-in approved! You can now create the payout.', 'success');
                
                // Find the row and update it to show "Create Payout" button
                const row = document.querySelector(`tr[data-clockin-id="${clockInRecordId}"]`);
                if (row) {
                    const statusCell = row.cells[7];
                    statusCell.innerHTML = '<span class="badge bg-success">Approved</span>';
                    
                    const actionCell = row.cells[8];
                    actionCell.innerHTML = `
                        <button class="btn btn-sm btn-primary" onclick="createPayoutForShift(${shiftId}, ${userId})">
                            <iconify-icon icon="solar:dollar-minimalistic-outline" class="icon text-sm"></iconify-icon>
                            Create Payout
                        </button>
                    `;
                }
                
            } catch (error) {
                console.error('Error approving clock-in:', error);
                showAlert('Error approving clock-in: ' + error.message, 'danger');
            }
        }

        async function createPayoutForShift(shiftId, userId) {
            const confirmed = await showConfirmModal(
                'Create Payout',
                'Are you sure you want to create a payout for this shift?',
                'Create Payout',
                'btn-primary'
            );
            
            if (!confirmed) return;

            try {
                const response = await maxicareAPI.createPayout(userId, shiftId, false);
                if (response.status) {
                    showAlert('Payout created successfully', 'success');
                    loadPayouts();
                    loadPayoutSummary();
                    loadCompletedShifts();
                }
            } catch (error) {
                console.error('Error creating payout:', error);
                showAlert('Error creating payout: ' + error.message, 'danger');
            }
        }

        // Process weekly payouts
        async function processWeeklyPayouts() {
            const confirmed = await showConfirmModal(
                'Process Weekly Payouts',
                'Are you sure you want to process weekly payouts for all completed shifts? This will create payouts for all eligible employees.',
                'Process All',
                'btn-success'
            );
            
            if (!confirmed) return;

            try {
                showAlert('Processing weekly payouts...', 'info');
                const response = await maxicareAPI.processWeeklyPayouts();
                if (response.status) {
                    showAlert(`Weekly payouts processed successfully. ${response.data.count} payouts created.`, 'success');
                    loadPayouts();
                    loadPayoutSummary();
                    loadCompletedShifts();
                }
            } catch (error) {
                console.error('Error processing weekly payouts:', error);
                showAlert('Error processing weekly payouts: ' + error.message, 'danger');
            }
        }

        // Filter payout requests
        function filterPayoutRequests() {
            const status = document.getElementById('statusFilter').value;
            loadPayoutRequests(status);
        }

        // Create payout
        async function createPayout() {
            const userId = document.getElementById('employeeSelect').value;
            const shiftId = document.getElementById('shiftSelect').value;
            const isEarlyPayout = document.getElementById('isEarlyPayout').checked;

            if (!userId || !shiftId) {
                showAlert('Please select both employee and shift', 'warning');
                return;
            }

            try {
                const response = await maxicareAPI.createPayout(userId, shiftId, isEarlyPayout);
                if (response.status) {
                    showAlert('Payout created successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createPayoutModal')).hide();
                    document.getElementById('createPayoutForm').reset();
                    loadPayouts();
                    loadPayoutSummary();
                }
            } catch (error) {
                console.error('Error creating payout:', error);
                showAlert('Error creating payout: ' + error.message, 'danger');
            }
        }

        // Open process payout modal
        function openProcessModal(payoutId) {
            document.getElementById('processPayoutId').value = payoutId;
            const modal = new bootstrap.Modal(document.getElementById('processPayoutModal'));
            modal.show();
        }

        // Process payout
        async function processPayout() {
            const payoutId = parseInt(document.getElementById('processPayoutId').value);
            const stripeAccountId = document.getElementById('stripeAccountId').value;

            // Validate payoutId
            if (isNaN(payoutId) || payoutId <= 0) {
                showAlert('Invalid payout ID', 'danger');
                return;
            }

            try {
                const response = await maxicareAPI.processPayout(payoutId, stripeAccountId || null);
                if (response.status) {
                    showAlert('Payout processed successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('processPayoutModal')).hide();
                    document.getElementById('processPayoutForm').reset();
                    loadPayouts();
                    loadPayoutSummary();
                }
            } catch (error) {
                console.error('Error processing payout:', error);
                showAlert('Error processing payout: ' + error.message, 'danger');
            }
        }

        // View payout details
        async function viewPayoutDetails(payoutId) {
            try {
                const response = await maxicareAPI.getPayoutById(payoutId);
                if (response.status) {
                    const payout = response.data;
                    let details = `Payout Details:\n\nID: ${payout.id}\nEmployee: ${payout.user ? `${payout.user.firstname} ${payout.user.lastname}` : 'N/A'}\nAmount: $${parseFloat(payout.amount).toFixed(2)}\nNet Amount: $${parseFloat(payout.netAmount).toFixed(2)}\nStatus: ${payout.status}\nType: ${payout.type}`;
                    
                    if (payout.failureReason) {
                        details += `\n\nFailure Reason:\n${payout.failureReason}`;
                    }
                    
                    if (payout.stripeTransferId) {
                        details += `\n\nStripe Transfer ID:\n${payout.stripeTransferId}`;
                    }
                    
                    alert(details);
                }
            } catch (error) {
                console.error('Error loading payout details:', error);
                showAlert('Error loading payout details', 'danger');
            }
        }

        // Retry failed payout
        async function retryFailedPayout(payoutId) {
            const confirmed = await showConfirmModal(
                'Retry Failed Payout',
                'Are you sure you want to retry this failed payout? This will reset the payout status and attempt to process it again.',
                'Retry Payout',
                'btn-warning'
            );
            
            if (!confirmed) return;

            try {
                const response = await maxicareAPI.retryPayout(payoutId);
                if (response.status) {
                    showAlert('Payout retry successful! The payout has been processed.', 'success');
                    loadPayouts();
                    loadPayoutSummary();
                } else {
                    showAlert('Error retrying payout: ' + (response.message || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error retrying payout:', error);
                showAlert('Error retrying payout: ' + error.message, 'danger');
            }
        }

        // Load payout requests
        async function loadPayoutRequests() {
            try {
                console.log('Loading payout requests...');
                const response = await maxicareAPI.getPayoutRequests({ status: 'pending' });
                console.log('Payout requests response:', response);
                
                if (response.status) {
                    const requests = response.data.requests || [];
                    console.log('Payout requests data:', requests);
                    
                    displayPayoutRequests(requests);
                    
                    const countElement = document.getElementById('pendingRequestsCount');
                    if (countElement) {
                        countElement.textContent = requests.length;
                    }
                } else {
                    console.error('Failed to load payout requests:', response.message);
                    showAlert('Failed to load payout requests: ' + (response.message || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error loading payout requests:', error);
                showAlert('Error loading payout requests: ' + error.message, 'danger');
            }
        }

        // Display payout requests in table
        function displayPayoutRequests(requests) {
            const tbody = document.getElementById('payoutRequestsTableBody');
            tbody.innerHTML = '';

            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No pending payout requests</td></tr>';
                return;
            }

            requests.forEach(request => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${request.id}</td>
                    <td>${request.user ? `${request.user.firstname} ${request.user.lastname}` : 'N/A'}</td>
                    <td>${request.shift ? request.shift.title : 'N/A'}</td>
                    <td>$${parseFloat(request.netAmount).toFixed(2)}</td>
                    <td><span class="badge ${request.type === 'early' ? 'bg-warning' : 'bg-info'}">${request.type}</span></td>
                    <td><span class="badge status-badge status-${request.status}">${request.status}</span></td>
                    <td>${new Date(request.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-success me-1" onclick="approvePayoutRequest(${request.id})">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejectPayoutRequest(${request.id})">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Approve payout request
        async function approvePayoutRequest(requestId) {
            const confirmed = await showConfirmModal(
                'Approve Payout Request',
                'Are you sure you want to approve this payout request?',
                'Approve',
                'btn-success'
            );
            
            if (!confirmed) return;

            try {
                const response = await maxicareAPI.updatePayoutRequest(requestId, 'approved');
                if (response.status) {
                    showAlert('Payout request approved successfully', 'success');
                    loadPayoutRequests();
                    loadPayouts();
                    loadPayoutSummary();
                }
            } catch (error) {
                console.error('Error approving payout request:', error);
                showAlert('Error approving payout request: ' + error.message, 'danger');
            }
        }

        // Reject payout request
        async function rejectPayoutRequest(requestId) {
            const reason = prompt('Please provide a reason for rejection:');
            if (reason === null) {
                return; // User cancelled
            }

            try {
                const response = await maxicareAPI.updatePayoutRequest(requestId, 'rejected', reason);
                if (response.status) {
                    showAlert('Payout request rejected successfully', 'success');
                    loadPayoutRequests();
                }
            } catch (error) {
                console.error('Error rejecting payout request:', error);
                showAlert('Error rejecting payout request: ' + error.message, 'danger');
            }
        }

        // Test function to verify both pagination and completed shifts fixes
        async function testBothFixes() {
            console.log('Testing both pagination and completed shifts fixes...');
            try {
                // Test getPayouts with pagination
                console.log('Testing pagination fix...');
                const payoutsResponse = await maxicareAPI.getPayouts({ page: 1, limit: 10 });
                console.log('Payouts API test result:', payoutsResponse);
                
                // Test getNotifications with pagination
                const notificationsResponse = await maxicareAPI.getNotifications(1, 5);
                console.log('Notifications API test result:', notificationsResponse);
                
                // Test completed shifts endpoint
                console.log('Testing completed shifts fix...');
                const completedShiftsResponse = await maxicareAPI.getCompletedShiftsForPayout();
                console.log('Completed shifts API test result:', completedShiftsResponse);
                
                const results = {
                    pagination: payoutsresponse.status && notificationsresponse.status,
                    completedShifts: completedShiftsresponse.status
                };
                
                if (results.pagination && results.completedShifts) {
                    console.log('✅ Both fixes successful!');
                    showAlert('Both pagination and completed shifts fixes passed!', 'success');
                } else if (results.pagination) {
                    console.log('✅ Pagination fix successful, but completed shifts still has issues');
                    showAlert('Pagination fix passed, but completed shifts still has issues', 'warning');
                } else if (results.completedShifts) {
                    console.log('✅ Completed shifts fix successful, but pagination still has issues');
                    showAlert('Completed shifts fix passed, but pagination still has issues', 'warning');
                } else {
                    console.log('❌ Both fixes failed');
                    showAlert('Both fixes failed', 'danger');
                }
                
                console.log('Test results:', results);
                return results;
            } catch (error) {
                console.error('❌ Test error:', error);
                showAlert('Test error: ' + error.message, 'danger');
                return { pagination: false, completedShifts: false, error: error.message };
            }
        }

        // Make test functions available globally
        window.testPaginationFix = testPaginationFix;
        window.testBothFixes = testBothFixes;

    </script>
    </div>
  </main>
</body>
</html>
