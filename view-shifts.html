<!-- meta tags and other links -->
<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Shifts - MaxiCare Admin Booking</title>
  <link rel="icon" type="image/png" href="assets/images/favicon.png" sizes="16x16">
  <!-- remix icon font css  -->
  <link rel="stylesheet" href="assets/css/remixicon.css">
  <!-- BootStrap css -->
  <link rel="stylesheet" href="assets/css/lib/bootstrap.min.css">
  <!-- Apex Chart css -->
  <link rel="stylesheet" href="assets/css/lib/apexcharts.css">
  <!-- Data Table css -->
  <link rel="stylesheet" href="assets/css/lib/dataTables.min.css">
  <!-- Text Editor css -->
  <link rel="stylesheet" href="assets/css/lib/editor-katex.min.css">
  <link rel="stylesheet" href="assets/css/lib/editor.atom-one-dark.min.css">
  <link rel="stylesheet" href="assets/css/lib/editor.quill.snow.css">
  <!-- Date picker css -->
  <link rel="stylesheet" href="assets/css/lib/flatpickr.min.css">
  <!-- Calendar css -->
  <link rel="stylesheet" href="assets/css/lib/full-calendar.css">
  <!-- Vector Map css -->
  <link rel="stylesheet" href="assets/css/lib/jquery-jvectormap-2.0.5.css">
  <!-- Popup css -->
  <link rel="stylesheet" href="assets/css/lib/magnific-popup.css">
  <!-- Slick Slider js -->
  <link rel="stylesheet" href="assets/css/lib/slick.css">
  <!-- prism css -->
  <link rel="stylesheet" href="assets/css/lib/prism.css">
  <!-- file upload css -->
  <link rel="stylesheet" href="assets/css/lib/file-upload.css">

  <link rel="stylesheet" href="assets/css/lib/audioplayer.css">
  <!-- main css -->
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- shift management css -->
  <link rel="stylesheet" href="assets/css/shift-management.css">
  <!-- notification fixes css -->
  <link rel="stylesheet" href="assets/css/notification-fixes.css">
  
  <style>
    /* Enhanced styling for view-shifts page */
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    
    .status-indicator.important {
      background-color: #f59e0b;
      animation: pulse 2s infinite;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-badge.important {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .status-progress {
      height: 4px;
      background-color: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
    }
    
    .status-progress .progress-bar {
      height: 100%;
      background-color: #f59e0b;
      transition: width 0.3s ease;
    }
    
    .status-progress .progress-bar.important {
      background-color: #f59e0b;
    }
    
    .time-remaining {
      font-size: 0.75rem;
      color: #f59e0b;
      font-weight: 500;
    }
    
    .time-remaining.important {
      color: #dc2626;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .card.border-danger-subtle {
      border-color: #fecaca !important;
      background-color: #fef2f2;
    }
    
    .bg-gradient-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    }
    
    .bg-gradient-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .bg-gradient-info {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    }
    
    .bg-gradient-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .bg-gradient-warning-50 {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }
    
    .white-20 {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .white-50 {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .text-white-50 {
      color: rgba(255, 255, 255, 0.5);
    }
    
    /* Enhanced table styling */
    .table th {
      background-color: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
      color: #475569;
    }
    
    .table td {
      vertical-align: middle;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .table tbody tr:hover {
      background-color: #f8fafc;
    }
    
    /* Modal enhancements */
    .modal-header {
      border-bottom: 1px solid #e2e8f0;
    }
    
    .modal-footer {
      border-top: 1px solid #e2e8f0;
    }
    
    /* Badge enhancements */
    .badge {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }
    
    /* Button enhancements */
    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
    }
    
    /* Loading state */
    .spinner-border {
      width: 2rem;
      height: 2rem;
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <button type="button" class="sidebar-close-btn">
      <iconify-icon icon="radix-icons:cross-2"></iconify-icon>
    </button>
    <div>
      <a href="index.html" class="sidebar-logo">
        <img src="assets/images/logo.png" alt="site logo" class="light-logo">
        <img src="assets/images/logo-light.png" alt="site logo" class="dark-logo">
        <img src="assets/images/logo-icon.png" alt="site logo" class="logo-icon">
      </a>
    </div>
    <div class="sidebar-menu-area">
      <ul class="sidebar-menu" id="sidebar-menu">
        <li>
          <a href="index.html">
            <iconify-icon icon="solar:home-smile-angle-outline" class="menu-icon"></iconify-icon>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="javascript:void(0)" class="disabled-link" style="opacity: 0.5; cursor: not-allowed;">
            <iconify-icon icon="solar:calendar-outline" class="menu-icon"></iconify-icon>
            <span>Calendar (Disabled)</span>
          </a>
        </li>
        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <iconify-icon icon="flowbite:users-group-outline" class="menu-icon"></iconify-icon>
            <span>Users</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="users-list.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Users
                List</a>
            </li>
            <li>
              <a href="add-user.html"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> Add User</a>
            </li>
            <li>
              <a href="view-profile.html"><i class="ri-circle-fill circle-icon text-danger-main w-auto"></i> View
                Profile</a>
            </li>
          </ul>
        </li>

        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <i class="ri-user-settings-line text-xl me-14 d-flex w-auto"></i>
            <span>Role & Access</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="role-access.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Role & Access</a>
            </li>
            <li>
              <a href="assign-role.html"><i class="ri-circle-fill circle-icon text-warning-main w-auto"></i> Assign Role</a>
            </li>
          </ul>
        </li>

        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <iconify-icon icon="solar:briefcase-outline" class="menu-icon"></iconify-icon>
            <span>Job Types</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="job-types.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Job Types List</a>
            </li>
            <li>
              <a href="add-job-type.html"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> Add Job Type</a>
            </li>
          </ul>
        </li>

        <li class="dropdown admin-only">
          <a href="javascript:void(0)">
            <iconify-icon icon="solar:clock-circle-outline" class="menu-icon"></iconify-icon>
            <span>Shift Management</span>
          </a>
          <ul class="sidebar-submenu">
            <li>
              <a href="add-shift.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Add Shift</a>
            </li>
            <li>
              <a href="view-shifts.html"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> View Shifts</a>
            </li>
          <li>
            <a href="clock-change-requests.html"><i class="ri-circle-fill circle-icon text-warning-main w-auto"></i> Clock Change Requests</a>
          </li>
          <li>
            <a href="javascript:void(0)" onclick="showShiftReports()"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> Employee Shift Reports</a>
          </li>
        </ul>
      </li>

        <li class="employee-only">
          <a href="my-shifts.html">
            <iconify-icon icon="solar:clock-circle-outline" class="menu-icon"></iconify-icon>
            <span>My Shifts</span>
          </a>
        </li>

        <li class="employee-only">
          <a href="available-shifts.html">
            <iconify-icon icon="solar:calendar-add-outline" class="menu-icon"></iconify-icon>
            <span>Available Shifts</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="dashboard-main">
    <div class="navbar-header">
      <div class="row align-items-center justify-content-between">
        <div class="col-auto">
          <div class="d-flex flex-wrap align-items-center gap-4">
            <button type="button" class="sidebar-toggle">
              <iconify-icon icon="heroicons:bars-3-solid" class="icon text-2xl non-active"></iconify-icon>
              <iconify-icon icon="iconoir:arrow-right" class="icon text-2xl active"></iconify-icon>
            </button>
            <button type="button" class="sidebar-mobile-toggle">
              <iconify-icon icon="heroicons:bars-3-solid" class="icon"></iconify-icon>
            </button>
            <form class="navbar-search">
              <input type="text" name="search" placeholder="Search">
              <iconify-icon icon="ion:search-outline" class="icon"></iconify-icon>
            </form>
          </div>
        </div>
        <div class="col-auto">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <button type="button" data-theme-toggle
              class="w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"></button>

            <div class="dropdown">
              <button
                class="has-indicator w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"
                type="button" data-bs-toggle="dropdown">
                <iconify-icon icon="iconoir:bell" class="text-primary-light text-xl"></iconify-icon>
              </button>
              <div class="dropdown-menu to-top dropdown-menu-lg p-0">
                <div
                  class="m-16 py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
                  <div>
                    <h6 class="text-lg text-primary-light fw-semibold mb-0">Notifications</h6>
                  </div>
                  <span
                    class="text-primary-600 fw-semibold text-lg w-40-px h-40-px rounded-circle bg-base d-flex justify-content-center align-items-center" id="notificationCount">0</span>
                </div>

                <div class="max-h-400-px overflow-y-auto scroll-sm pe-4" id="notificationsList">
                  <!-- Notifications will be loaded here -->
                  <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-secondary-light text-sm">Loading notifications...</p>
                  </div>
                </div>

                <div class="text-center py-12 px-16">
                  <a href="javascript:void(0)" class="text-primary-600 fw-semibold text-md">See All Notification</a>
                </div>

              </div>
            </div><!-- Notification dropdown end -->

            <div class="dropdown">
              <button class="d-flex justify-content-center align-items-center rounded-circle" type="button"
                data-bs-toggle="dropdown">
                <img src="assets/images/user.png" alt="image" class="w-40-px h-40-px object-fit-cover rounded-circle">
              </button>
              <div class="dropdown-menu to-top dropdown-menu-sm">
                <div
                  class="py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
                  <div>
                    <h6 class="text-lg text-primary-light fw-semibold mb-2 user-name">Loading...</h6>
                    <span class="text-secondary-light fw-medium text-sm user-role">Loading...</span>
                  </div>
                  <button type="button" class="hover-text-danger">
                    <iconify-icon icon="radix-icons:cross-1" class="icon text-xl"></iconify-icon>
                  </button>
                </div>
                <ul class="to-top-list">
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3"
                      href="view-profile.html">
                      <iconify-icon icon="solar:user-linear" class="icon text-xl"></iconify-icon> My Profile</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3"
                      href="email.html">
                      <iconify-icon icon="tabler:message-check" class="icon text-xl"></iconify-icon> Inbox</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3"
                      href="company.html">
                      <iconify-icon icon="icon-park-outline:setting-two" class="icon text-xl"></iconify-icon>
                      Setting</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-danger d-flex align-items-center gap-3"
                      href="javascript:void(0)" id="logoutBtn">
                      <iconify-icon icon="lucide:power" class="icon text-xl"></iconify-icon> Log Out</a>
                  </li>
                </ul>
              </div>
            </div><!-- Profile dropdown end -->
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-main-body">
      <!-- Header Section -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <div>
          <h6 class="fw-semibold mb-0">Shift Management Dashboard</h6>
          <p class="text-secondary-light mb-0">Monitor ongoing shifts and manage all shift operations</p>
        </div>
        <ul class="d-flex align-items-center gap-2">
          <li class="fw-medium">
            <a href="index.html" class="d-flex align-items-center gap-1 hover-text-primary">
              <iconify-icon icon="solar:home-smile-angle-outline" class="icon text-lg"></iconify-icon>
              Dashboard
            </a>
          </li>
          <li>-</li>
          <li class="fw-medium">View Shifts</li>
        </ul>
      </div>

      <!-- Real-time Status Cards -->
      <div class="row mb-24">
        <div class="col-lg-3 col-md-6 mb-16">
          <div class="card border-0 bg-gradient-primary text-white h-100">
            <div class="card-body p-20">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <h6 class="text-white mb-8">Ongoing Shifts</h6>
                  <h3 class="text-white mb-0" id="ongoingCount">0</h3>
                  <p class="text-white-50 mb-0 text-sm">Currently active</p>
                </div>
                <div class="w-60-px h-60-px bg-white-20 rounded-circle d-flex align-items-center justify-content-center">
                  <iconify-icon icon="solar:clock-circle-bold" class="icon text-2xl text-white"></iconify-icon>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-16">
          <div class="card border-0 bg-gradient-success text-white h-100">
            <div class="card-body p-20">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <h6 class="text-white mb-8">Pending Shifts</h6>
                  <h3 class="text-white mb-0" id="scheduledCount">0</h3>
                  <p class="text-white-50 mb-0 text-sm">Open & Scheduled</p>
                </div>
                <div class="w-60-px h-60-px bg-white-20 rounded-circle d-flex align-items-center justify-content-center">
                  <iconify-icon icon="solar:calendar-outline" class="icon text-2xl text-white"></iconify-icon>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-16">
          <div class="card border-0 bg-gradient-info text-white h-100">
            <div class="card-body p-20">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <h6 class="text-white mb-8">Total Employees</h6>
                  <h3 class="text-white mb-0" id="totalEmployees">0</h3>
                  <p class="text-white-50 mb-0 text-sm">On duty today</p>
                </div>
                <div class="w-60-px h-60-px bg-white-20 rounded-circle d-flex align-items-center justify-content-center">
                  <iconify-icon icon="solar:users-group-rounded-outline" class="icon text-2xl text-white"></iconify-icon>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-16">
          <div class="card border-0 bg-gradient-warning text-white h-100">
            <div class="card-body p-20">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <h6 class="text-white mb-8">Completed</h6>
                  <h3 class="text-white mb-0" id="completedCount">0</h3>
                  <p class="text-white-50 mb-0 text-sm">Today's completed</p>
                </div>
                <div class="w-60-px h-60-px bg-white-20 rounded-circle d-flex align-items-center justify-content-center">
                  <iconify-icon icon="solar:check-circle-outline" class="icon text-2xl text-white"></iconify-icon>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ongoing Shifts Section -->
      <div class="card mb-24">
        <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-3">
            <iconify-icon icon="solar:clock-circle-bold" class="icon text-xl text-warning-600"></iconify-icon>
            <h6 class="fw-semibold mb-0">Ongoing Shifts</h6>
            <span class="badge bg-warning-100 text-warning-600" id="ongoingBadge">0</span>
          </div>
          <button class="btn btn-outline-primary btn-sm" onclick="refreshOngoingShifts()">
            <iconify-icon icon="solar:refresh-outline" class="icon text-sm me-1"></iconify-icon>
            Refresh
          </button>
        </div>
        <div class="card-body p-24">
          <div id="ongoingShiftsContainer">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-secondary-light">Loading ongoing shifts...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- All Shifts Management -->
      <div class="card">
        <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center flex-wrap gap-3 justify-content-between">
          <div class="d-flex align-items-center flex-wrap gap-3">
            <h6 class="fw-semibold mb-0">All Shifts</h6>
            <form class="navbar-search">
              <input type="text" class="bg-base h-40-px w-auto" name="search" placeholder="Search shifts..." id="searchInput">
              <iconify-icon icon="ion:search-outline" class="icon"></iconify-icon>
            </form>
            <select class="form-select form-select-sm w-auto ps-12 py-6 radius-12 h-40-px" id="statusFilter">
              <option value="">All Status</option>
              <option value="open">Open</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
            <select class="form-select form-select-sm w-auto ps-12 py-6 radius-12 h-40-px" id="dateFilter">
              <option value="">All Dates</option>
              <option value="today">Today</option>
              <option value="tomorrow">Tomorrow</option>
              <option value="week">This Week</option>
            </select>
          </div>
          <a href="add-shift.html" class="btn btn-primary text-sm btn-sm px-12 py-12 radius-8 d-flex align-items-center gap-2">
            <iconify-icon icon="ic:baseline-plus" class="icon text-xl line-height-1"></iconify-icon>
            Add New Shift
          </a>
        </div>
        <div class="card-body p-24">
          <div class="table-responsive scroll-sm">
            <table class="table bordered-table sm-table mb-0" id="shiftsTable">
              <thead>
                <tr>
                  <th scope="col">S.L</th>
                  <th scope="col">Date</th>
                  <th scope="col">Title</th>
                  <th scope="col">Job Type</th>
                  <th scope="col">Time</th>
                  <th scope="col">Employees</th>
                  <th scope="col" class="text-center">Status</th>
                  <th scope="col" class="text-center">Progress</th>
                  <th scope="col" class="text-center">Action</th>
                </tr>
              </thead>
              <tbody id="shiftsTableBody">
                <!-- Data will be loaded here -->
              </tbody>
            </table>
          </div>

          <!-- DataTables will handle pagination automatically -->
        </div>
      </div>
    </div>

    <footer class="d-footer">
      <div class="row align-items-center justify-content-between">
        <div class="col-auto">
          <p class="mb-0">Â© 2024 MaxiCare Admin Booking. All Rights Reserved.</p>
        </div>
        <div class="col-auto">
          <p class="mb-0">Made by <span class="text-primary-600">MaxiCare Team</span></p>
        </div>
      </div>
    </footer>
  </main>

  <!-- jQuery library js -->
  <script src="assets/js/lib/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap js -->
  <script src="assets/js/lib/bootstrap.bundle.min.js"></script>
  <!-- Apex Chart js -->
  <script src="assets/js/lib/apexcharts.min.js"></script>
  <!-- Data Table js -->
  <script src="assets/js/lib/dataTables.min.js"></script>
  <!-- Iconify Font js -->
  <script src="assets/js/lib/iconify-icon.min.js"></script>
  <!-- jQuery UI js -->
  <script src="assets/js/lib/jquery-ui.min.js"></script>
  <!-- Vector Map js -->
  <script src="assets/js/lib/jquery-jvectormap-2.0.5.min.js"></script>
  <script src="assets/js/lib/jquery-jvectormap-world-mill-en.js"></script>
  <!-- Popup js -->
  <script src="assets/js/lib/magnifc-popup.min.js"></script>
  <!-- Slick Slider js -->
  <script src="assets/js/lib/slick.min.js"></script>
  <!-- prism js -->
  <script src="assets/js/lib/prism.js"></script>
  <!-- file upload js -->
  <script src="assets/js/lib/file-upload.js"></script>
  <!-- audioplayer -->
  <script src="assets/js/lib/audioplayer.js"></script>

  <!-- API and Auth services -->
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/router.js"></script>
  <!-- main js -->
  <script src="assets/js/app.js"></script>

  <script>
    let shiftsData = [];
    let jobTypesData = [];
    let usersData = [];
    let clockRecordsData = {};
    let ongoingShifts = [];
    let refreshInterval;

    document.addEventListener('DOMContentLoaded', async function() {
      // Check authentication and admin role
      if (!authService.requireAuth()) {
        return;
      }

      if (!authService.isAdmin()) {
        showToast('Access denied. Admin privileges required.', 'error');
        window.location.href = 'index.html';
        return;
      }

      // Add logout functionality
      document.getElementById('logoutBtn').addEventListener('click', async function() {
        await authService.logout();
        window.location.href = 'sign-in.html';
      });

      // Load data
      await loadAllData();

      // Load notifications
      await loadNotifications();

      // Initialize real-time updates
      startRealTimeUpdates();

      // Add event listeners
      document.getElementById('statusFilter').addEventListener('change', filterShifts);
      document.getElementById('dateFilter').addEventListener('change', filterShifts);
      document.getElementById('searchInput').addEventListener('input', filterShifts);

      // DataTable will be initialized after data is loaded
    });

    async function loadAllData() {
      try {
        // Show loading state
        showLoadingState();
        
        await Promise.all([
          loadShifts(),
          loadJobTypes(),
          loadUsers(),
          loadClockRecords()
        ]);
        
        updateDashboardStats();
        renderOngoingShifts();
        renderShiftsTable();
        
        // Initialize DataTable after data is loaded
        initializeDataTable();
        
        // Hide loading state
        hideLoadingState();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading data: ' + error.message, 'error');
        hideLoadingState();
      }
    }
    
    function showLoadingState() {
      const tbody = document.getElementById('shiftsTableBody');
      tbody.innerHTML = `
        <tr>
          <td colspan="9" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-secondary-light mb-0">Loading shifts data...</p>
          </td>
        </tr>
      `;
      
      // Loading state handled by DataTables
    }
    
    function hideLoadingState() {
      // Loading state will be replaced by actual data in renderShiftsTable
    }

    // Initialize DataTable
    function initializeDataTable() {
      if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#shiftsTable')) {
        $('#shiftsTable').DataTable({
          responsive: true,
          pageLength: 10,
          order: [[1, 'desc']] // Sort by date descending
        });
      }
    }

    async function loadShifts() {
      try {
        const response = await maxicareAPI.getShifts();
        
        if (response.status && response.data) {
          // Handle new API response structure: data.shifts instead of data directly
          let shiftsArray = [];
          
          if (response.data.shifts && Array.isArray(response.data.shifts)) {
            // New structure: response.data.shifts
            shiftsArray = response.data.shifts;
          } else if (Array.isArray(response.data)) {
            // Old structure: response.data directly
            shiftsArray = response.data;
          }

          // Process shifts to determine status
          shiftsData = shiftsArray.map(shift => processShiftStatus(shift));
          // Note: ongoingShifts will be updated after clock records are loaded
        } else {
          console.warn('No shifts data received or invalid response format:', response);
          shiftsData = [];
          ongoingShifts = [];
        }
      } catch (error) {
        console.error('Error loading shifts:', error);
        showToast('Error loading shifts: ' + error.message, 'error');
        shiftsData = [];
        ongoingShifts = [];
      }
    }

    async function loadJobTypes() {
      try {
        const response = await maxicareAPI.getJobTypes();
        if (response.status && response.data) {
          // Ensure response.data is an array
          jobTypesData = Array.isArray(response.data) ? response.data : [];
        } else {
           jobTypesData = [];
        }
      } catch (error) {
        console.error('Error loading job types:', error);
        jobTypesData = [];
      }
    }

    async function loadUsers() {
      try {
        const response = await maxicareAPI.getUsers();
        if (response.status && response.data) {
          // Ensure response.data is an array
          usersData = Array.isArray(response.data) ? response.data : [];
        } else {
           usersData = [];
        }
      } catch (error) {
        console.error('Error loading users:', error);
        usersData = [];
      }
    }

    async function loadClockRecords() {
      try {
        // Get all clock-in records using the correct API endpoint
        const response = await maxicareAPI.getClockInRecords(1, 1000);

        if (response.status && response.data && response.data.records) {
          const clockRecordsArray = response.data.records;
 
          // Group clock records by shift ID
          clockRecordsData = clockRecordsArray.reduce((acc, record) => {
            if (!acc[record.shiftId]) {
              acc[record.shiftId] = [];
            }
            acc[record.shiftId].push(record);
            return acc;
          }, {});
          
          // Update shifts with actual clock records data
          updateShiftsWithClockRecords();
          
          // Calculate and display analytics
          calculateShiftAnalytics();
        } else {
          console.warn('No clock records data received or invalid response format:', response);
          clockRecordsData = {};
        }
      } catch (error) {
        console.error('Error loading clock records:', error);
        clockRecordsData = {};
      }
    }

    async function loadClockRecordsPerShift() {
      try {
        clockRecordsData = {};
        
        // Get clock records for each shift individually
        for (const shift of shiftsData) {
          try {
            const response = await maxicareAPI.getShiftClockInRecords(shift.id, 1, 100);
            if (response.status && response.data) {
              let records = [];
              if (response.data.records && Array.isArray(response.data.records)) {
                records = response.data.records;
              } else if (Array.isArray(response.data)) {
                records = response.data;
              }
              
              if (records.length > 0) {
                clockRecordsData[shift.id] = records;
              }
            }
          } catch (shiftError) {
            console.warn(`Failed to load clock records for shift ${shift.id}:`, shiftError);
          }
        }
        
        updateShiftsWithClockRecords();
      } catch (error) {
        console.error('Error in fallback clock records loading:', error);
        clockRecordsData = {};
      }
    }

    function updateShiftsWithClockRecords() {
      // Update each shift with its actual clock records
      shiftsData.forEach(shift => {
        if (clockRecordsData[shift.id]) {
          shift.clockInRecords = clockRecordsData[shift.id];
          
          // Calculate employee counts based on clock records
          const totalRecords = shift.clockInRecords.length;
          const activeRecords = shift.clockInRecords.filter(record => 
            record.clockInTime && !record.clockOutTime
          ).length;
          const completedRecords = shift.clockInRecords.filter(record => 
            record.clockInTime && record.clockOutTime
          ).length;
          
          // Update shift with actual counts from clock records
          shift.currentEmployees = totalRecords;
          shift.activeEmployees = activeRecords;
          shift.completedEmployees = completedRecords;
          
          // Normalize field names for consistency
          shift.clockInRecords = shift.clockInRecords.map(record => ({
            ...record,
            clockIn: record.clockInTime,
            clockOut: record.clockOutTime,
            userId: record.userId,
            user: record.user,
            status: record.status
          }));
        } else {
          shift.clockInRecords = [];
          shift.currentEmployees = 0;
          shift.activeEmployees = 0;
          shift.completedEmployees = 0;
        }
      });
  
      // Update ongoing shifts after processing clock records
      ongoingShifts = getOngoingShifts();
    }

    function getOngoingShifts() {
      const now = new Date();
      
      return shiftsData.filter(shift => {
        // Parse shift times
        let shiftStartTime, shiftEndTime;
        if (typeof shift.startTime === 'string') {
          shiftStartTime = new Date(shift.startTime);
        } else {
          shiftStartTime = shift.startTime;
        }
        
        if (typeof shift.endTime === 'string') {
          shiftEndTime = new Date(shift.endTime);
        } else {
          shiftEndTime = shift.endTime;
        }
        
        // Check if shift is currently in time range
        const isInTimeRange = now >= shiftStartTime && now <= shiftEndTime;
        
        // Check if shift has active employees (clocked in but not out)
        const hasActiveEmployees = shift.clockInRecords && shift.clockInRecords.some(record => 
          record.clockInTime && !record.clockOutTime
        );
        
        // A shift is ongoing if:
        // 1. It's currently in the time range AND
        // 2. It has active employees (people clocked in but not out)
        // This is consistent with the status determination logic
        const isOngoing = isInTimeRange && hasActiveEmployees;
        
        return isOngoing;
      });
    }

    function calculateShiftAnalytics() {
      const now = new Date();
      let ongoingShiftsCount = 0;
      let completedShiftsCount = 0;
      let scheduledShiftsCount = 0;
      let onDutyEmployees = new Set();
      let totalClockIns = new Set();
      let completedClockRecords = 0;

      // Analyze all shifts with their clock records
      shiftsData.forEach(shift => {
        const shiftStartTime = new Date(shift.startTime);
        const shiftEndTime = new Date(shift.endTime);
        
        // Check if shift has clock records
        if (shift.clockInRecords && shift.clockInRecords.length > 0) {
          // Count unique employees who have clocked in
          shift.clockInRecords.forEach(record => {
            totalClockIns.add(record.userId);
            
            // Count employees currently on duty (clocked in but not out)
            if (record.clockInTime && !record.clockOutTime) {
              onDutyEmployees.add(record.userId);
            }
            
            // Count completed clock records
            if (record.clockInTime && record.clockOutTime) {
              completedClockRecords++;
            }
          });
          
          // Determine shift status based on time and clock records (consistent with processShiftStatus)
          if (now < shiftStartTime) {
            // Shift hasn't started yet
            scheduledShiftsCount++;
          } else if (now > shiftEndTime) {
            // Shift has ended - count as completed if it has any clock records
            if (shift.clockInRecords && shift.clockInRecords.length > 0) {
              completedShiftsCount++;
            }
          } else {
            // Shift is currently in time range
            const hasActiveEmployees = shift.clockInRecords && shift.clockInRecords.some(record => 
              record.clockInTime && !record.clockOutTime
            );
            
            if (hasActiveEmployees) {
              // Has active employees (clocked in but not out)
              ongoingShiftsCount++;
            }
            // Note: 'open' shifts in time range are not counted in any specific category
          }
        } else {
          // Shift has no clock records
          if (now < shiftStartTime) {
            scheduledShiftsCount++;
          }
          // Don't count shifts without clock records as completed
        }
      });

      // Update dashboard with calculated analytics
      updateDashboardWithAnalytics({
        ongoing: ongoingShiftsCount,
        completed: completedShiftsCount,
        scheduled: scheduledShiftsCount,
        onDutyEmployees: onDutyEmployees.size,
        totalClockIns: totalClockIns.size,
        completedClockRecords: completedClockRecords
      });
    }

    function updateDashboardWithAnalytics(analytics) {
      // Update dashboard stats with calculated analytics
      document.getElementById('ongoingCount').textContent = analytics.ongoing;
      document.getElementById('scheduledCount').textContent = analytics.scheduled;
      document.getElementById('completedCount').textContent = analytics.completed;
      document.getElementById('totalEmployees').textContent = analytics.onDutyEmployees;
      document.getElementById('ongoingBadge').textContent = analytics.ongoing;
      
      // Add additional analytics if elements exist
      const totalClockInsElement = document.getElementById('totalClockIns');
      const completedShiftsElement = document.getElementById('completedShifts');
      
      if (totalClockInsElement) {
        totalClockInsElement.textContent = analytics.totalClockIns;
      }
      
      if (completedShiftsElement) {
        completedShiftsElement.textContent = analytics.completedClockRecords;
      }
      
      // Add animation to stats
      animateCounters();
    }

    function processShiftStatus(shift) {
      const now = new Date();
      
      // Handle different date formats from backend
      let shiftDate, shiftStartTime, shiftEndTime;
      
      if (typeof shift.date === 'string') {
        shiftDate = new Date(shift.date);
      } else {
        shiftDate = shift.date;
      }
      
      if (typeof shift.startTime === 'string') {
        shiftStartTime = new Date(shift.startTime);
      } else {
        shiftStartTime = shift.startTime;
      }
      
      if (typeof shift.endTime === 'string') {
        shiftEndTime = new Date(shift.endTime);
      } else {
        shiftEndTime = shift.endTime;
      }
      
      // Enhanced clock records analysis using the correct field names
      const hasActiveUsers = shift.clockInRecords && shift.clockInRecords.some(record => 
        record.clockInTime && !record.clockOutTime
      );
      
      const hasCompletedUsers = shift.clockInRecords && shift.clockInRecords.some(record => 
        record.clockInTime && record.clockOutTime
      );

      // Update current employees count based on actual clock records
      if (shift.clockInRecords) {
        shift.currentEmployees = shift.clockInRecords.length;
        // Count active employees (clocked in but not out)
        shift.activeEmployees = shift.clockInRecords.filter(record => 
          record.clockInTime && !record.clockOutTime
        ).length;
        // Count completed employees (clocked in and out)
        shift.completedEmployees = shift.clockInRecords.filter(record => 
          record.clockInTime && record.clockOutTime
        ).length;
      } else {
        shift.currentEmployees = 0;
        shift.activeEmployees = 0;
        shift.completedEmployees = 0;
      }

      const originalStatus = shift.status;
      
      // Enhanced status determination based on clock records and time
      if (now < shiftStartTime) {
        // Shift hasn't started yet
        shift.status = 'scheduled';
      } else if (now > shiftEndTime) {
        // Shift has ended - check if it was completed or just ended
        if (shift.clockInRecords && shift.clockInRecords.length > 0) {
          // Has clock records, so it was worked on
          shift.status = 'completed';
        } else {
          // No clock records, so it just ended without being worked
          shift.status = 'ended';
        }
      } else {
        // Shift is currently in time range (now >= shiftStartTime && now <= shiftEndTime)
        if (hasActiveUsers) {
          // Has active employees (clocked in but not out)
          shift.status = 'in-progress';
        } else {
          // No active employees, but shift is open for pickup
          shift.status = 'open';
        }
      }
      
      return shift;
    }

    function updateDashboardStats() {
      // If we have clock records data, use the enhanced analytics calculation
      if (Object.keys(clockRecordsData).length > 0) {
        calculateShiftAnalytics();
        return;
      }
      
      // Fallback to basic calculation if no clock records available
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      
      // Ensure shiftsData is an array
      const safeShiftsData = Array.isArray(shiftsData) ? shiftsData : [];
      
      // Get today's shifts for ongoing and completed counts
      const todayShifts = safeShiftsData.filter(shift => {
        let shiftDate;
        if (typeof shift.date === 'string') {
          shiftDate = new Date(shift.date);
        } else {
          shiftDate = shift.date;
        }
        
        const shiftLocalDate = new Date(shiftDate.getFullYear(), shiftDate.getMonth(), shiftDate.getDate());
        const todayLocalDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        
        return shiftLocalDate.getTime() === todayLocalDate.getTime();
      });
      
      // Get all pending shifts (future shifts that are open or scheduled)
      const pendingShifts = safeShiftsData.filter(shift => {
        let shiftDate;
        if (typeof shift.date === 'string') {
          shiftDate = new Date(shift.date);
        } else {
          shiftDate = shift.date;
        }
        
        const shiftLocalDate = new Date(shiftDate.getFullYear(), shiftDate.getMonth(), shiftDate.getDate());
        const todayLocalDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        
        // Include shifts that are today or in the future and are open or scheduled
        const isTodayOrFuture = shiftLocalDate.getTime() >= todayLocalDate.getTime();
        const isPending = shift.status === 'open' || shift.status === 'scheduled';
        
        return isTodayOrFuture && isPending;
      });
      
      const ongoing = todayShifts.filter(shift => shift.status === 'in-progress').length;
      const scheduled = pendingShifts.length;
      const completed = todayShifts.filter(shift => shift.status === 'completed').length;

      // Update dashboard stats with basic analytics
      document.getElementById('ongoingCount').textContent = ongoing;
      document.getElementById('scheduledCount').textContent = scheduled;
      document.getElementById('completedCount').textContent = completed;
      document.getElementById('totalEmployees').textContent = 0; // No clock records data
      document.getElementById('ongoingBadge').textContent = ongoing;
      
      console.log('Basic Dashboard Analytics (no clock records):', {
        ongoing,
        scheduled,
        completed,
        onDutyEmployees: 0
      });
      
      // Add animation to stats
      animateCounters();
    }
    
    function animateCounters() {
      const counters = ['ongoingCount', 'scheduledCount', 'completedCount', 'totalEmployees'];
      counters.forEach(id => {
        const element = document.getElementById(id);
        const target = parseInt(element.textContent);
        let current = 0;
        const increment = target / 20;
        
        const timer = setInterval(() => {
          current += increment;
          if (current >= target) {
            element.textContent = target;
            clearInterval(timer);
          } else {
            element.textContent = Math.floor(current);
          }
        }, 50);
      });
    }

    function renderOngoingShifts() {
      const container = document.getElementById('ongoingShiftsContainer');

      // Ensure ongoingShifts is an array
      if (!Array.isArray(ongoingShifts) || ongoingShifts.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <iconify-icon icon="solar:clock-circle-outline" class="icon text-4xl text-secondary-light mb-3"></iconify-icon>
            <h6 class="text-secondary-light mb-2">No Ongoing Shifts</h6>
            <p class="text-secondary-light mb-0">All shifts are either completed or not yet started.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = ongoingShifts.map(shift => createOngoingShiftCard(shift)).join('');
    }

    function createOngoingShiftCard(shift) {
      // Use job data from shift if available, otherwise fallback to jobTypesData lookup
      const jobType = shift.job || jobTypesData.find(jt => jt.id === shift.jobId);
      const now = new Date();
      
      // Parse dates properly - handle both string and Date objects
      let startTime, endTime;
      if (typeof shift.startTime === 'string') {
        startTime = new Date(shift.startTime);
      } else {
        startTime = shift.startTime;
      }
      
      if (typeof shift.endTime === 'string') {
        endTime = new Date(shift.endTime);
      } else {
        endTime = shift.endTime;
      }
      
      const totalDuration = endTime - startTime;
      
      // Find active employees
      const activeEmployees = shift.clockInRecords ? shift.clockInRecords.filter(record => 
        record.clockInTime && !record.clockOutTime
      ) : [];

      // Calculate progress for the shift
      const elapsed = now - startTime;
      let progress = 0;
      
      if (totalDuration > 0) {
        if (now < startTime) {
          // Shift hasn't started yet
          progress = 0;
        } else if (now > endTime) {
          // Shift has ended
          progress = 100;
        } else {
          // Shift is in progress
          progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
        }
      }
      
      const remaining = endTime - now;
      const remainingHours = Math.max(0, Math.floor(remaining / (1000 * 60 * 60)));
      const remainingMinutes = Math.max(0, Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60)));

      return `
        <div class="card border-0 bg-gradient-warning-50 mb-3">
          <div class="card-body p-20">
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="d-flex align-items-center gap-3 mb-2">
                  <div class="status-indicator important"></div>
                  <h6 class="mb-0 fw-semibold text-primary-light">${shift.title}</h6>
                  <span class="status-badge important">
                    <iconify-icon icon="solar:clock-circle-bold" class="icon text-sm"></iconify-icon>
                    In Progress
                  </span>
                </div>
                <div class="d-flex align-items-center gap-4 text-secondary-light text-sm mb-2">
                  <span class="d-flex align-items-center gap-1">
                    <iconify-icon icon="solar:calendar-outline" class="icon text-sm"></iconify-icon>
                    ${formatDate(shift.date)}
                  </span>
                  <span class="d-flex align-items-center gap-1">
                    <iconify-icon icon="solar:clock-circle-outline" class="icon text-sm"></iconify-icon>
                    ${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}
                  </span>
                  <span class="d-flex align-items-center gap-1">
                    <iconify-icon icon="solar:users-group-rounded-outline" class="icon text-sm"></iconify-icon>
                    ${shift.activeEmployees || activeEmployees.length} active, ${shift.completedEmployees || 0} completed / ${shift.maxEmployees} employees
                  </span>
                </div>
                <div class="status-progress mb-2">
                  <div class="progress-bar important" style="width: ${progress}%"></div>
                </div>
                <div class="d-flex align-items-center gap-3">
                  <span class="text-sm text-warning-600">
                    <iconify-icon icon="solar:clock-circle-bold" class="icon text-sm me-1"></iconify-icon>
                    ${Math.round(progress)}% complete
                  </span>
                  <span class="time-remaining important">
                    <iconify-icon icon="solar:clock-circle-outline" class="icon text-sm"></iconify-icon>
                    ${remaining > 0 ? `${remainingHours}h ${remainingMinutes}m left` : 'Shift ended'}
                  </span>
                </div>
              </div>
              <div class="col-md-4 text-end">
                <div class="d-flex flex-column gap-2 align-items-end">
                  <button class="btn btn-outline-primary btn-sm" onclick="viewShiftDetails(${shift.id})">
                    <iconify-icon icon="solar:eye-outline" class="icon text-sm me-1"></iconify-icon>
                    View Details
                  </button>
                  <div class="d-flex flex-wrap gap-1 justify-content-end">
                    ${activeEmployees.map(record => {
                      const user = usersData.find(u => u.id === record.userId);
                      return user ? `
                        <span class="badge bg-success text-white" title="${user.firstname} ${user.lastname}">
                          ${user.firstname.charAt(0)}${user.lastname.charAt(0)}
                        </span>
                      ` : '';
                    }).join('')}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderShiftsTable() {
      const tbody = document.getElementById('shiftsTableBody');
      tbody.innerHTML = '';

      // Ensure shiftsData is an array
      if (!Array.isArray(shiftsData) || shiftsData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center py-5">
              <div class="d-flex flex-column align-items-center">
                <iconify-icon icon="solar:calendar-outline" class="icon text-4xl text-secondary-light mb-3"></iconify-icon>
                <h6 class="text-secondary-light mb-2">No Shifts Found</h6>
                <p class="text-secondary-light mb-3">There are no shifts to display at the moment.</p>
                <a href="add-shift.html" class="btn btn-primary btn-sm">
                  <iconify-icon icon="ic:baseline-plus" class="icon text-sm me-1"></iconify-icon>
                  Add New Shift
                </a>
              </div>
            </td>
          </tr>
        `;
        // No shifts found - DataTables will handle display
        return;
      }

      shiftsData.forEach((shift, index) => {
        const row = createShiftRow(shift, index + 1);
        tbody.appendChild(row);
      });

      // Info text handled by DataTables
    }

    function createShiftRow(shift, index) {
      const tr = document.createElement('tr');
      // Use job data from shift if available, otherwise fallback to jobTypesData lookup
      const jobType = shift.job || jobTypesData.find(jt => jt.id === shift.jobId);
      const statusClass = getStatusClass(shift.status);
      const statusText = getStatusText(shift.status);
      const timeRange = `${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}`;
      // Enhanced employee count display with active/completed breakdown
      let employeeCount = `${shift.currentEmployees}/${shift.maxEmployees}`;
      if (shift.activeEmployees !== undefined && shift.completedEmployees !== undefined) {
        employeeCount = `${shift.activeEmployees} active, ${shift.completedEmployees} completed / ${shift.maxEmployees}`;
      }
      
      // Calculate progress for all shifts based on time and status
      let progressHtml = '';
      const now = new Date();
      
      // Parse dates properly - handle both string and Date objects
      let startTime, endTime;
      if (typeof shift.startTime === 'string') {
        startTime = new Date(shift.startTime);
      } else {
        startTime = shift.startTime;
      }
      
      if (typeof shift.endTime === 'string') {
        endTime = new Date(shift.endTime);
      } else {
        endTime = shift.endTime;
      }
      
      const totalDuration = endTime - startTime;
      let progress = 0;
      let progressClass = 'bg-secondary';
      
      if (totalDuration > 0) {
        if (now < startTime) {
          // Shift hasn't started yet
          progress = 0;
          progressClass = 'bg-secondary';
        } else if (now > endTime) {
          // Shift has ended
          progress = 100;
          progressClass = shift.status === 'completed' ? 'bg-success' : 'bg-secondary';
        } else {
          // Shift is in progress
          const elapsed = now - startTime;
          progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
          progressClass = 'bg-warning';
        }
      }
      
      progressHtml = `
        <div class="progress" style="height: 6px; min-width: 50px; max-width: 80px;">
          <div class="progress-bar ${progressClass}" style="width: ${progress}%"></div>
        </div>
        <small class="text-muted">${Math.round(progress)}%</small>
      `;
      
      tr.innerHTML = `
        <td>${index.toString().padStart(2, '0')}</td>
        <td>${formatDate(shift.date)}</td>
        <td>
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <span class="text-md mb-0 fw-normal text-secondary-light">${shift.title}</span>
            </div>
          </div>
        </td>
        <td>${jobType ? jobType.title : 'Unknown'}</td>
        <td><span class="text-md mb-0 fw-normal text-secondary-light">${timeRange}</span></td>
        <td><span class="text-md mb-0 fw-normal text-secondary-light">${employeeCount}</span></td>
        <td class="text-center">
          <span class="${statusClass} px-24 py-4 radius-4 fw-medium text-sm">${statusText}</span>
        </td>
        <td class="text-center">
          ${progressHtml}
        </td>
        <td class="text-center">
          <div class="d-flex align-items-center gap-10 justify-content-center">
            <button type="button" class="bg-info-focus bg-hover-info-200 text-info-600 fw-medium w-40-px h-40-px d-flex justify-content-center align-items-center rounded-circle" onclick="viewShiftDetails(${shift.id})" title="View Details">
              <iconify-icon icon="majesticons:eye-line" class="icon text-xl"></iconify-icon>
            </button>
            <button type="button" class="bg-success-focus text-success-600 bg-hover-success-200 fw-medium w-40-px h-40-px d-flex justify-content-center align-items-center rounded-circle" onclick="editShift(${shift.id})" title="Edit Shift">
              <iconify-icon icon="lucide:edit" class="menu-icon"></iconify-icon>
            </button>
            <button type="button" class="remove-item-btn bg-danger-focus bg-hover-danger-200 text-danger-600 fw-medium w-40-px h-40-px d-flex justify-content-center align-items-center rounded-circle" onclick="deleteShift(${shift.id})" title="Delete Shift">
              <iconify-icon icon="fluent:delete-24-regular" class="menu-icon"></iconify-icon>
            </button>
          </div>
        </td>
      `;
      
      return tr;
    }

    function getStatusClass(status) {
      switch(status) {
        case 'open':
          return 'bg-success-focus text-success-600 border border-success-main';
        case 'scheduled':
          return 'bg-primary-focus text-primary-600 border border-primary-main';
        case 'in-progress':
          return 'bg-warning-focus text-warning-600 border border-warning-main';
        case 'completed':
          return 'bg-info-focus text-info-600 border border-info-main';
        case 'ended':
          return 'bg-secondary-focus text-secondary-600 border border-secondary-main';
        default:
          return 'bg-neutral-200 text-neutral-600 border border-neutral-400';
      }
    }

    function getStatusText(status) {
      switch(status) {
        case 'open':
          return 'Open';
        case 'scheduled':
          return 'Scheduled';
        case 'in-progress':
          return 'In Progress';
        case 'completed':
          return 'Completed';
        case 'ended':
          return 'Ended';
        default:
          return 'Unknown';
      }
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }

    function formatTime(dateTimeString) {
      if (!dateTimeString) return 'N/A';
      
      let date;
      if (typeof dateTimeString === 'string') {
        // Handle different time formats
        if (dateTimeString.includes('T')) {
          date = new Date(dateTimeString);
        } else if (dateTimeString.includes(':')) {
          // Handle time-only format (HH:MM)
          const today = new Date();
          const [hours, minutes] = dateTimeString.split(':');
          date = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parseInt(hours), parseInt(minutes));
        } else {
          date = new Date(dateTimeString);
        }
      } else {
        date = dateTimeString;
      }
      
      if (isNaN(date.getTime())) {
        return 'Invalid Time';
      }
      
      return date.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    }

    function startRealTimeUpdates() {
      // Update every 30 seconds
      refreshInterval = setInterval(() => {
        refreshOngoingShifts();
      }, 30000);
    }

    async function refreshOngoingShifts() {
      try {
        // Re-load shifts data to get latest status
        await loadShifts();
        
        // Re-process shift statuses
        shiftsData = shiftsData.map(shift => processShiftStatus(shift));
        ongoingShifts = getOngoingShifts();
        
        updateDashboardStats();
        renderOngoingShifts();
        renderShiftsTable();
        
      } catch (error) {
        console.error('Error refreshing ongoing shifts:', error);
        showToast('Error refreshing data', 'error');
      }
    }

    function viewShiftDetails(shiftId) {
      const shift = shiftsData.find(s => s.id === shiftId);
      if (!shift) return;

      const jobType = jobTypesData.find(jt => jt.id === shift.jobId);

      console.log('Shifts data:', shift);
      console.log('jobType:', jobType);
      // Create a detailed view modal with proper formatting
      const modalHtml = `
        <div class="modal fade" id="viewShiftModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <iconify-icon icon="solar:eye-outline" class="icon text-xl me-2"></iconify-icon>
                  Shift Details - ${shift.title}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="card h-100">
                      <div class="card-header bg-primary-50">
                        <h6 class="mb-0 text-primary-600">
                          <iconify-icon icon="solar:clock-circle-outline" class="icon text-sm me-1"></iconify-icon>
                          Shift Information
                        </h6>
                      </div>
                      <div class="card-body">
                        <div class="mb-3">
                          <strong>Title:</strong><br>
                          <span class="text-secondary-light">${shift.title}</span>
                        </div>
                        <div class="mb-3">
                          <strong>Date:</strong><br>
                          <span class="text-secondary-light">${formatDate(shift.date)}</span>
                        </div>
                        <div class="mb-3">
                          <strong>Time:</strong><br>
                          <span class="text-secondary-light">${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}</span>
                        </div>
                        <div class="mb-3">
                          <strong>Type:</strong><br>
                          <span class="badge bg-info-subtle text-info-600">${shift.type.charAt(0).toUpperCase() + shift.type.slice(1)}</span>
                        </div>
                        <div class="mb-3">
                          <strong>Status:</strong><br>
                          <span class="badge ${getStatusClass(shift.status)}">${getStatusText(shift.status)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card h-100">
                      <div class="card-header bg-success-50">
                        <h6 class="mb-0 text-success-600">
                          <iconify-icon icon="solar:briefcase-outline" class="icon text-sm me-1"></iconify-icon>
                          Job Details
                        </h6>
                      </div>
                      <div class="card-body">
                        <div class="mb-3">
                          <strong>Job Type:</strong><br>
                          <span class="text-secondary-light">${jobType ? jobType.title : 'Unknown'}</span>
                        </div>
                        <div class="mb-3">
                          <strong>Max Employees:</strong><br>
                          <span class="text-secondary-light">${shift.maxEmployees}</span>
                        </div>
                        <div class="mb-3">
                          <strong>Current Employees:</strong><br>
                          <span class="text-secondary-light">${shift.currentEmployees || 0}</span>
                        </div>
                        <div class="mb-3">
                          <strong>Required Skills:</strong><br>
                          <span class="text-secondary-light">${shift.requiredSkills || 'Not specified'}</span>
                        </div>
                        <div class="mb-3">
                          <strong>Break Duration:</strong><br>
                          <span class="text-secondary-light">${shift.breakDuration || 0} minutes</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header bg-info-50">
                        <h6 class="mb-0 text-info-600">
                          <iconify-icon icon="solar:document-text-outline" class="icon text-sm me-1"></iconify-icon>
                          Description
                        </h6>
                      </div>
                      <div class="card-body">
                        <p class="mb-0">${shift.description || 'No description provided'}</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                ${shift.clockInRecords && shift.clockInRecords.length > 0 ? `
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header bg-warning-50">
                        <h6 class="mb-0 text-warning-600">
                          <iconify-icon icon="solar:users-group-rounded-outline" class="icon text-sm me-1"></iconify-icon>
                          Clock Records
                        </h6>
                      </div>
                      <div class="card-body p-0">
                        <div class="table-responsive">
                          <table class="table table-sm mb-0">
                            <thead class="table-light">
                              <tr>
                                <th>Employee</th>
                                <th>Clock In</th>
                                <th>Clock Out</th>
                                <th>Status</th>
                                <th>Note</th>
                              </tr>
                            </thead>
                            <tbody>
                              ${shift.clockInRecords.map(record => {
                                const user = usersData.find(u => u.id === record.userId);
                                return `
                                  <tr>
                                    <td>
                                      <div class="d-flex align-items-center">
                                        <div class="w-32-px h-32-px bg-primary-100 rounded-circle d-flex align-items-center justify-content-center me-2">
                                          <span class="text-primary-600 fw-semibold text-sm">
                                            ${user ? `${user.firstname.charAt(0)}${user.lastname.charAt(0)}` : '??'}
                                          </span>
                                        </div>
                                        <span class="text-sm">${user ? `${user.firstname} ${user.lastname}` : 'Unknown User'}</span>
                                      </div>
                                    </td>
                                    <td>
                                      <span class="text-sm">
                                        ${record.clockIn ? formatTime(record.clockIn) : 'Not clocked in'}
                                      </span>
                                    </td>
                                    <td>
                                      <span class="text-sm">
                                        ${record.clockOut ? formatTime(record.clockOut) : 'Still working'}
                                      </span>
                                    </td>
                                    <td>
                                      <span class="badge ${record.clockOut ? 'bg-success' : 'bg-warning'}">
                                        ${record.clockOut ? 'Completed' : 'Active'}
                                      </span>
                                    </td>
                                    <td>
                                      <span class="text-sm text-secondary-light">
                                        ${record.note || '-'}
                                      </span>
                                    </td>
                                  </tr>
                                `;
                              }).join('')}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                ` : ''}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <iconify-icon icon="solar:close-circle-outline" class="icon text-sm me-1"></iconify-icon>
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById('viewShiftModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('viewShiftModal'));
      modal.show();

      // Remove modal from DOM when hidden
      document.getElementById('viewShiftModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
      });
    }

    function editShift(shiftId) {
      const shift = shiftsData.find(s => s.id === shiftId);
      if (!shift) {
        showToast('Shift not found', 'error');
        return;
      }
      
      // Redirect to add-shift page with edit parameters
      const params = new URLSearchParams({
        edit: 'true',
        id: shiftId,
        title: shift.title,
        type: shift.type,
        date: shift.date,
        startTime: shift.startTime,
        endTime: shift.endTime,
        jobId: shift.jobId,
        requiredSkills: shift.requiredSkills,
        description: shift.description || '',
        maxEmployees: shift.maxEmployees,
        breakDuration: shift.breakDuration || 0
      });
      
      window.location.href = `add-shift.html?${params.toString()}`;
    }

    async function deleteShift(shiftId) {
      const shift = shiftsData.find(s => s.id === shiftId);
      if (!shift) return;

      // Create a better confirmation dialog
      const confirmModal = createDeleteConfirmationModal(shift);
      document.body.insertAdjacentHTML('beforeend', confirmModal);
      
      const modal = new bootstrap.Modal(document.getElementById('deleteShiftModal'));
      modal.show();

      // Handle confirmation
      document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        try {
          // Call the API to delete the shift
          await maxicareAPI.deleteShift(shiftId);
          
          // Remove from local data
          shiftsData = shiftsData.filter(s => s.id !== shiftId);
          ongoingShifts = getOngoingShifts();
          
          // Update UI
          updateDashboardStats();
          renderOngoingShifts();
          renderShiftsTable();
          
          // Close modal and show success message
          modal.hide();
          showToast('Shift deleted successfully', 'success');
        } catch (error) {
          console.error('Error deleting shift:', error);
          showToast('Failed to delete shift: ' + error.message, 'error');
        }
      });

      // Enable delete button only when checkbox is checked
      document.getElementById('confirmDeleteCheckbox').addEventListener('change', function() {
        document.getElementById('confirmDeleteBtn').disabled = !this.checked;
      });

      // Remove modal when hidden
      document.getElementById('deleteShiftModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
      });
    }

    function createDeleteConfirmationModal(shift) {
      const jobType = jobTypesData.find(jt => jt.id === shift.jobId);
      return `
        <div class="modal fade" id="deleteShiftModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header border-0">
                <h5 class="modal-title text-danger">
                  <iconify-icon icon="solar:danger-triangle-outline" class="icon text-xl me-2"></iconify-icon>
                  Delete Shift
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                  <iconify-icon icon="solar:danger-triangle-bold" class="icon text-xl me-2"></iconify-icon>
                  <div>
                    <strong>Warning!</strong> This action cannot be undone.
                  </div>
                </div>
                
                <p class="mb-3">Are you sure you want to delete this shift?</p>
                
                <div class="card border-danger-subtle">
                  <div class="card-body">
                    <h6 class="card-title text-danger mb-2">${shift.title}</h6>
                    <div class="row text-sm">
                      <div class="col-6">
                        <strong>Date:</strong><br>
                        ${formatDate(shift.date)}
                      </div>
                      <div class="col-6">
                        <strong>Time:</strong><br>
                        ${formatTime(shift.startTime)} - ${formatTime(shift.endTime)}
                      </div>
                      <div class="col-6 mt-2">
                        <strong>Job Type:</strong><br>
                        ${jobType ? jobType.title : 'Unknown'}
                      </div>
                      <div class="col-6 mt-2">
                        <strong>Status:</strong><br>
                        <span class="badge ${getStatusClass(shift.status)}">${getStatusText(shift.status)}</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="mt-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmDeleteCheckbox">
                    <label class="form-check-label text-sm" for="confirmDeleteCheckbox">
                      I understand this action cannot be undone
                    </label>
                  </div>
                </div>
              </div>
              <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                  <iconify-icon icon="solar:trash-bin-minimalistic-outline" class="icon text-sm me-1"></iconify-icon>
                  Delete Shift
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function filterShifts() {
      const statusFilter = document.getElementById('statusFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      // Ensure shiftsData is an array
      let filteredShifts = Array.isArray(shiftsData) ? shiftsData : [];

      // Apply status filter
      if (statusFilter) {
        filteredShifts = filteredShifts.filter(shift => shift.status === statusFilter);
      }

      // Apply date filter
      if (dateFilter) {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay());

        filteredShifts = filteredShifts.filter(shift => {
          const shiftDate = new Date(shift.date);
          switch (dateFilter) {
            case 'today':
              return shiftDate.toDateString() === today.toDateString();
            case 'tomorrow':
              return shiftDate.toDateString() === tomorrow.toDateString();
            case 'week':
              return shiftDate >= startOfWeek;
            default:
              return true;
          }
        });
      }

      // Apply search filter
      if (searchTerm) {
        filteredShifts = filteredShifts.filter(shift => 
          shift.title.toLowerCase().includes(searchTerm) ||
          (jobTypesData.find(jt => jt.id === shift.jobId)?.title || '').toLowerCase().includes(searchTerm)
        );
      }

      // Update table with filtered data
      const tbody = document.getElementById('shiftsTableBody');
      tbody.innerHTML = '';

      filteredShifts.forEach((shift, index) => {
        const row = createShiftRow(shift, index + 1);
        tbody.appendChild(row);
      });

      // Info text handled by DataTables
    }

    function showToast(message, type) {
      // Create toast container if it doesn't exist
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
      }

      const toastId = 'toast-' + Date.now();
      const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;

      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement);
      toast.show();

      // Remove toast element after it's hidden
      toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
      });
    }

    // Clean up interval when page unloads
    window.addEventListener('beforeunload', function() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });

    // Original remove functionality for demo data
    $('.remove-item-btn').on('click', function () {
      $(this).closest('tr').addClass('d-none')
    }); 

    // Shift Reports functionality
    let currentReportData = null;

    function showShiftReports() {
      const modal = new bootstrap.Modal(document.getElementById('shiftReportsModal'));
      modal.show();
      
      // Populate job types dropdown
      populateJobTypesDropdown();
      
      // Set default date range (last 30 days)
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);
      
      document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
      document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
    }

    function populateJobTypesDropdown() {
      const jobTypeSelect = document.getElementById('reportJobType');
      jobTypeSelect.innerHTML = '<option value="">All Job Types</option>';
      
      if (jobTypesData && jobTypesData.length > 0) {
        jobTypesData.forEach(jobType => {
          const option = document.createElement('option');
          option.value = jobType.id;
          option.textContent = jobType.title;
          jobTypeSelect.appendChild(option);
        });
      }
    }

    async function generateReport() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;
      const status = document.getElementById('reportStatus').value;
      const jobId = document.getElementById('reportJobType').value;

      // Show loading state
      document.getElementById('reportLoading').style.display = 'block';
      document.getElementById('reportSummary').style.display = 'none';
      document.getElementById('reportData').style.display = 'none';
      document.getElementById('downloadExcelBtn').disabled = true;

      try {
        const filters = {
          startDate: startDate || undefined,
          endDate: endDate || undefined,
          status: status || undefined,
          jobId: jobId && jobId !== '' ? parseInt(jobId) : undefined
        };

        console.log('Generating report with filters:', filters);
        const response = await maxicareAPI.generateShiftReport(filters);
        
        if (response.status) {
          currentReportData = response.data;
          displayReportSummary(response.data.summary);
          displayReportData(response.data.employees);
          document.getElementById('downloadExcelBtn').disabled = false;
        } else {
          showToast('Failed to generate report: ' + response.message, 'error');
        }
      } catch (error) {
        console.error('Error generating report:', error);
        showToast('Failed to generate report. Please try again.', 'error');
      } finally {
        document.getElementById('reportLoading').style.display = 'none';
      }
    }

    function displayReportSummary(summary) {
      document.getElementById('totalShiftsCount').textContent = summary.totalEmployees;
      document.getElementById('totalScheduledHours').textContent = summary.totalShifts;
      document.getElementById('totalActualHours').textContent = summary.totalHours.toFixed(1);
      document.getElementById('averageEfficiency').textContent = summary.averageHoursPerEmployee.toFixed(1) + 'h';
      
      document.getElementById('reportSummary').style.display = 'block';
    }

    function displayReportData(employees) {
      const tbody = document.getElementById('reportsTableBody');
      tbody.innerHTML = '';

      employees.forEach(employee => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${employee.id}</td>
          <td>${employee.name}</td>
          <td>${employee.email}</td>
          <td>${employee.title || 'N/A'}</td>
          <td>${employee.totalShifts}</td>
          <td>${employee.totalHours.toFixed(1)}h</td>
          <td>${employee.completedShifts}</td>
          <td>${employee.activeShifts}</td>
          <td>$${employee.totalEarnings.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('reportData').style.display = 'block';
    }

    function downloadExcelReport() {
      if (!currentReportData) {
        showToast('No report data available. Please generate a report first.', 'error');
        return;
      }

      // Create Excel data for employee timesheet
      const excelData = [
        // Header row
        ['Employee ID', 'Name', 'Email', 'Role', 'Total Shifts', 'Total Hours', 'Completed Shifts', 'In Progress Shifts', 'Average Hours/Shift']
      ];

      // Add employee summary rows
      currentReportData.shifts.forEach(employee => {
        excelData.push([
          employee.employeeId,
          employee.employeeName,
          employee.email,
          employee.role,
          employee.totalShifts,
          employee.totalHours.toFixed(1),
          employee.shifts.filter(s => s.status === 'Completed').length,
          employee.shifts.filter(s => s.status === 'In Progress').length,
          employee.totalShifts > 0 ? (employee.totalHours / employee.totalShifts).toFixed(1) : '0.0'
        ]);
      });

      // Add detailed shift data
      excelData.push([]); // Empty row
      excelData.push(['DETAILED SHIFT RECORDS']);
      excelData.push(['Employee Name', 'Shift Title', 'Date', 'Start Time', 'End Time', 'Clock In', 'Clock Out', 'Hours Worked', 'Job Type', 'Status']);

      currentReportData.shifts.forEach(employee => {
        employee.shifts.forEach(shift => {
          excelData.push([
            employee.employeeName,
            shift.shiftTitle,
            formatDate(shift.date),
            formatTime(shift.startTime),
            formatTime(shift.endTime),
            formatDateTime(shift.clockIn),
            shift.clockOut ? formatDateTime(shift.clockOut) : 'N/A',
            shift.hoursWorked.toFixed(1),
            shift.jobTitle,
            shift.status
          ]);
        });
      });

      // Convert to CSV and download
      const csvContent = excelData.map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `employee-timesheet-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    function formatDateTime(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleString();
    }
  </script>

  <!-- Shift Reports Modal -->
  <div class="modal fade" id="shiftReportsModal" tabindex="-1" aria-labelledby="shiftReportsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="shiftReportsModalLabel">Employee Shift Reports</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Report Filters -->
          <div class="row mb-4">
            <div class="col-md-3">
              <label for="reportStartDate" class="form-label">Start Date</label>
              <input type="date" class="form-control" id="reportStartDate">
            </div>
            <div class="col-md-3">
              <label for="reportEndDate" class="form-label">End Date</label>
              <input type="date" class="form-control" id="reportEndDate">
            </div>
            <div class="col-md-3">
              <label for="reportStatus" class="form-label">Status</label>
              <select class="form-select" id="reportStatus">
                <option value="">All Status</option>
                <option value="open">Open</option>
                <option value="scheduled">Scheduled</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="reportJobType" class="form-label">Job Type</label>
              <select class="form-select" id="reportJobType">
                <option value="">All Job Types</option>
              </select>
            </div>
          </div>
          
          <div class="d-flex gap-2 mb-4">
            <button class="btn btn-primary" onclick="generateReport()">
              <iconify-icon icon="solar:document-outline" class="icon text-sm me-1"></iconify-icon>
              Generate Report
            </button>
            <button class="btn btn-success" onclick="downloadExcelReport()" id="downloadExcelBtn" disabled>
              <iconify-icon icon="solar:download-outline" class="icon text-sm me-1"></iconify-icon>
              Download Excel
            </button>
          </div>

          <!-- Report Summary -->
          <div id="reportSummary" class="mb-4" style="display: none;">
            <div class="row">
              <div class="col-md-3">
                <div class="card bg-primary-50">
                  <div class="card-body text-center">
                    <h6 class="text-primary-600">Total Employees</h6>
                    <h4 class="text-primary-600" id="totalShiftsCount">0</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-info-50">
                  <div class="card-body text-center">
                    <h6 class="text-info-600">Total Shifts</h6>
                    <h4 class="text-info-600" id="totalScheduledHours">0</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-success-50">
                  <div class="card-body text-center">
                    <h6 class="text-success-600">Total Hours</h6>
                    <h4 class="text-success-600" id="totalActualHours">0</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-warning-50">
                  <div class="card-body text-center">
                    <h6 class="text-warning-600">Avg Hours/Employee</h6>
                    <h4 class="text-warning-600" id="averageEfficiency">0h</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Report Data Table -->
          <div id="reportData" style="display: none;">
            <div class="table-responsive">
              <table class="table table-striped" id="reportsTable">
                <thead>
                  <tr>
                    <th>Employee ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Total Shifts</th>
                    <th>Total Hours</th>
                    <th>Completed</th>
                    <th>In Progress</th>
                    <th>Avg Hours/Shift</th>
                  </tr>
                </thead>
                <tbody id="reportsTableBody">
                </tbody>
              </table>
            </div>
          </div>

          <!-- Loading State -->
          <div id="reportLoading" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-secondary-light">Generating report...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Notification functions
    async function loadNotifications() {
      try {
        console.log('Loading notifications...');
        
        // Load unread count
        const countResponse = await maxicareAPI.getUnreadNotificationCount();
        if (countResponse && countResponse.status) {
          const countEl = document.getElementById('notificationCount');
          if (countEl) {
            countEl.textContent = countResponse.data.count;
          }
        }

        // Load recent notifications
        const notificationsResponse = await maxicareAPI.getNotifications(1, 5);
        if (notificationsResponse && notificationsResponse.status) {
          updateNotificationsList(notificationsResponse.data.notifications);
        } else {
          showNoNotificationsMessage();
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
        showNoNotificationsMessage();
      }
    }

    function updateNotificationsList(notifications) {
      const notificationsList = document.getElementById('notificationsList');
      if (!notificationsList) return;

      if (notifications.length === 0) {
        showNoNotificationsMessage();
        return;
      }

      notificationsList.innerHTML = notifications.map(notification => `
        <a href="javascript:void(0)" 
           class="px-24 py-12 d-flex align-items-start gap-3 mb-2 justify-content-between ${notification.isRead ? '' : 'bg-neutral-50'}"
           onclick="markNotificationAsRead(${notification.id})">
          <div class="text-black hover-bg-transparent hover-text-primary d-flex align-items-center gap-3">
            <span class="w-44-px h-44-px ${getNotificationIconClass(notification.type)} rounded-circle d-flex justify-content-center align-items-center flex-shrink-0">
              <iconify-icon icon="${getNotificationIcon(notification.type)}" class="icon text-xxl"></iconify-icon>
            </span>
            <div>
              <h6 class="text-md fw-semibold mb-4">${notification.title}</h6>
              <p class="mb-0 text-sm text-secondary-light text-w-200-px">${notification.message}</p>
            </div>
          </div>
          <span class="text-sm text-secondary-light flex-shrink-0">${formatTimeAgo(notification.createdAt)}</span>
        </a>
      `).join('');
    }

    function showNoNotificationsMessage() {
      const notificationsList = document.getElementById('notificationsList');
      if (!notificationsList) return;

      notificationsList.innerHTML = `
        <div class="text-center py-4">
          <iconify-icon icon="solar:bell-outline" class="icon text-4xl text-secondary-light mb-2"></iconify-icon>
          <p class="text-secondary-light mb-0">No notifications</p>
        </div>
      `;
    }

    function getNotificationIcon(type) {
      const iconMap = {
        'shift_assigned': 'solar:clock-circle-outline',
        'shift_completed': 'solar:check-circle-outline',
        'shift_cancelled': 'solar:close-circle-outline',
        'user_registered': 'solar:user-plus-outline',
        'system_announcement': 'solar:megaphone-outline',
        'shift_reminder': 'solar:alarm-outline',
        'payment_processed': 'solar:wallet-outline',
        'profile_updated': 'solar:user-outline',
        'password_changed': 'solar:lock-outline',
        'login_attempt': 'solar:login-3-outline'
      };
      return iconMap[type] || 'solar:bell-outline';
    }

    function getNotificationIconClass(type) {
      const classMap = {
        'shift_assigned': 'bg-primary-subtle text-primary-main',
        'shift_completed': 'bg-success-subtle text-success-main',
        'shift_cancelled': 'bg-danger-subtle text-danger-main',
        'user_registered': 'bg-info-subtle text-info-main',
        'system_announcement': 'bg-warning-subtle text-warning-main',
        'shift_reminder': 'bg-warning-subtle text-warning-main',
        'payment_processed': 'bg-success-subtle text-success-main',
        'profile_updated': 'bg-info-subtle text-info-main',
        'password_changed': 'bg-warning-subtle text-warning-main',
        'login_attempt': 'bg-info-subtle text-info-main'
      };
      return classMap[type] || 'bg-secondary-subtle text-secondary-main';
    }

    async function markNotificationAsRead(notificationId) {
      try {
        await maxicareAPI.markNotificationAsRead(notificationId);
        // Reload notifications to update the UI
        await loadNotifications();
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }
  </script>

</body>

</html>
